{% extends "_base.html" %}

{% block title %}Model Readiness • dubbing_pipeline{% endblock %}

{% block content %}
<div x-data="readinessPage()" x-init="init()">
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold">Model Readiness Dashboard</h1>
      <p class="mt-1 text-sm text-slate-400">Dependency and model cache status (no models are loaded).</p>
    </div>
    <button class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm" @click="load()">Refresh</button>
  </div>
  <div class="mt-2 text-sm text-slate-400" x-show="status" x-cloak x-text="status"></div>

  <div class="mt-6">
    <template x-if="!data">
      <div class="text-sm text-slate-500">Loading…</div>
    </template>
    <template x-if="data">
      <div class="grid gap-4">
        <template x-for="section in data.sections" :key="section.title">
          <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
            <div class="text-sm text-slate-300" x-text="section.title"></div>
            <div class="mt-3 overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-xs text-slate-500">
                  <tr>
                    <th class="text-left py-1 pr-3">Component</th>
                    <th class="text-left py-1 pr-3">Status</th>
                    <th class="text-left py-1 pr-3">Reason</th>
                    <th class="text-left py-1 pr-3">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="item in section.items" :key="section.title + ':' + item.name">
                    <tr class="border-t border-slate-900">
                      <td class="py-1 pr-3 text-slate-200" x-text="item.name"></td>
                      <td class="py-1 pr-3">
                        <span class="text-xs rounded border border-slate-800 px-2 py-0.5"
                              :class="statusClass(item.status)"
                              x-text="item.status"></span>
                      </td>
                      <td class="py-1 pr-3 text-slate-400" x-text="item.reason"></td>
                      <td class="py-1 pr-3 text-slate-400" x-text="item.action"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <template x-if="section.selected_by_mode && Array.isArray(section.selected_by_mode)">
              <div class="mt-4">
                <div class="text-xs text-slate-500">Selected by mode</div>
                <div class="mt-2 grid gap-2 sm:grid-cols-3">
                  <template x-for="m in section.selected_by_mode" :key="section.title + ':' + m.mode">
                    <div class="rounded-lg border border-slate-800 bg-slate-950/20 p-3">
                      <div class="text-xs text-slate-500" x-text="m.mode"></div>
                      <div class="text-sm text-slate-200" x-text="m.asr_model"></div>
                      <div class="mt-1 text-xs"
                           :class="m.cached ? 'text-emerald-200' : 'text-amber-200'"
                           x-text="m.cached ? 'cached' : 'not cached'"></div>
                      <div class="mt-1 text-xs text-slate-500" x-show="m.reasons && m.reasons.length" x-cloak>
                        <span x-text="m.reasons.join(', ')"></span>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </template>
      </div>
    </template>
  </div>
</div>

<script>
  function readinessPage() {
    return {
      data: null,
      status: "",
      async init() { await this.load(); },
      statusClass(s) {
        const v = String(s || "").toLowerCase();
        if (v === "ok") return "bg-emerald-900/30 text-emerald-200";
        if (v === "disabled") return "bg-slate-900/60 text-slate-300";
        return "bg-amber-900/30 text-amber-200";
      },
      async load() {
        this.status = "";
        try {
          const r = await fetch("/api/system/readiness", { credentials: "include" });
          if (!r.ok) {
            this.status = "Unavailable (" + r.status + ")";
            return;
          }
          this.data = await r.json();
        } catch (e) {
          this.status = "Unavailable";
        }
      },
    };
  }
</script>
{% endblock %}
