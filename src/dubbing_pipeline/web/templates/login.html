{% extends "_base.html" %}

{% block title %}Login â€¢ dubbing_pipeline{% endblock %}

{% block content %}
<div class="mx-auto max-w-md">
  <div class="rounded-xl border border-slate-800 bg-slate-900/50 p-6">
    <h1 class="text-xl font-semibold">Sign in</h1>
    <p class="mt-1 text-sm text-slate-400">Use your admin/operator account.</p>

    <div id="loginError" class="mt-4 rounded-lg bg-red-900/30 border border-red-900/50 p-3 text-sm text-red-200"
         role="alert" aria-live="polite"
         x-show="error" x-cloak x-text="error"></div>

    <form class="mt-4 space-y-3" x-data="{username:'', password:'', totp:'', error:''}"
      @submit.prevent="
        error='';
        fetch('/api/auth/login', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({username, password, totp, session: true})
        }).then(async (r) => {
          let data = {};
          try { data = await r.json(); } catch(e) {}
          if (!r.ok) {
            error = (data && (data.detail || data.error)) ? (data.detail || data.error) : ('Login failed (' + r.status + ')');
            return;
          }
          // Refresh the CSRF input to match the server-set cookie.
          if (data && data.csrf_token) document.getElementById('csrf').value = data.csrf_token;
          window.location = '/ui/dashboard';
        }).catch((e) => { error = 'Login failed'; });
      "
    >
      <div>
        <label class="block text-sm text-slate-300" for="username">Username</label>
        <input id="username" class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-slate-100"
               name="username" autocomplete="username" required
               aria-describedby="loginHelp"
               x-model="username" />
      </div>

      <div>
        <label class="block text-sm text-slate-300" for="password">Password</label>
        <input id="password" class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-slate-100"
               type="password" name="password" autocomplete="current-password" required
               aria-describedby="loginHelp"
               x-model="password" />
      </div>

      <div>
        <label class="block text-sm text-slate-300" for="totp">TOTP (optional)</label>
        <input id="totp" class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-slate-100"
               name="totp" inputmode="numeric" placeholder="123456"
               aria-describedby="loginHelp"
               x-model="totp" />
      </div>

      <button type="submit" class="w-full rounded-lg bg-indigo-600 hover:bg-indigo-500 px-3 py-3 font-medium">
        Sign in
      </button>

      <p id="loginHelp" class="text-xs text-slate-500">
        This UI uses a signed session cookie. CSRF is required for state-changing actions.
      </p>
    </form>
  </div>
</div>
{% endblock %}

