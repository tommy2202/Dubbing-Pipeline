<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dubbing Pipeline – Player</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
      h2 { margin: 0 0 12px 0; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; }
      .panel { flex: 1 1 320px; }
      select { width: 100%; padding: 10px; font-size: 16px; }
      video { width: 100%; max-width: 960px; background: #000; border-radius: 10px; }
      .muted { color: #666; font-size: 14px; }
      /* token is never rendered */
    </style>
  </head>
  <body>
    <h2>Dubbing Pipeline</h2>
    <div class="muted">
      Web player + job queue. Sign in to get a session cookie (recommended).
    </div>

    <div class="row" style="margin-top: 12px;">
      <div class="panel">
        <h3 style="margin: 0 0 8px 0;">Sign in</h3>
        <div class="row" style="gap:8px;">
          <input id="username" type="text" placeholder="username" style="flex:1; padding:10px; font-size:16px;" />
          <input id="password" type="password" placeholder="password" style="flex:1; padding:10px; font-size:16px;" />
        </div>
        <div class="row" style="gap:8px; margin-top:8px;">
          <input id="totp" type="text" placeholder="TOTP (if enabled)" style="flex:1; padding:10px; font-size:16px;" />
          <label class="muted" style="display:flex; align-items:center; gap:6px;">
            <input id="useSession" type="checkbox" checked />
            session cookie
          </label>
        </div>
        <button id="login" style="margin-top:10px; padding:10px; width:100%; font-size:16px;">Login</button>

        <h3 style="margin: 16px 0 8px 0;">Create Job</h3>

        <div class="muted" style="margin-top:10px;">Server file path (inside /app), or upload:</div>
        <input id="video_path" type="text" placeholder="/app/Input/Test.mp4 (copy from samples/Test.mp4)" style="width:100%; padding:10px; font-size:16px; margin:6px 0;" />
        <input id="file" type="file" accept="video/*" style="width:100%; margin:6px 0;" />

        <div class="row" style="gap:8px;">
          <select id="mode">
            <option value="low">low</option>
            <option value="medium" selected>medium</option>
            <option value="high">high</option>
          </select>
          <select id="device">
            <option value="auto" selected>auto</option>
            <option value="cuda">cuda</option>
            <option value="cpu">cpu</option>
          </select>
        </div>
        <div class="row" style="gap:8px; margin-top:8px;">
          <input id="src_lang" type="text" value="auto" placeholder="src-lang" style="flex:1; padding:10px; font-size:16px;" />
          <input id="tgt_lang" type="text" value="en" placeholder="tgt-lang" style="flex:1; padding:10px; font-size:16px;" />
        </div>
        <button id="submit" style="margin-top:10px; padding:10px; width:100%; font-size:16px;">Submit job</button>

        <div class="muted" style="margin-top:10px;">Live progress</div>
        <div style="background:#eee; border-radius:8px; overflow:hidden;">
          <div id="bar" style="height:10px; width:0%; background:#2b7; transition:width 0.2s;"></div>
        </div>
        <div id="status" class="muted" style="margin-top:6px;"></div>
      </div>

      <div class="panel" style="flex: 2 1 520px;">
        <h3 style="margin: 0 0 8px 0;">Player</h3>
        <div class="muted" style="margin-bottom:8px;">
          <a id="webrtcLink" href="/webrtc/demo">WebRTC preview</a>
        </div>
        <label class="muted" for="job">Choose a file</label>
        <select id="job">
          {% for v in videos %}
          <option value="{{ v.job }}">{{ v.name }}</option>
          {% endfor %}
        </select>
        <div class="muted" style="margin-top: 8px;">
          Tip: seeking works (Range requests).
        </div>
        <video id="player" controls playsinline>
          <source id="source" src="" />
          Your browser does not support HTML5 video.
        </video>
        <h3 style="margin: 16px 0 8px 0;">Jobs</h3>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr class="muted">
              <th style="text-align:left; padding:6px;">id</th>
              <th style="text-align:left; padding:6px;">state</th>
              <th style="text-align:left; padding:6px;">progress</th>
              <th style="text-align:left; padding:6px;">actions</th>
            </tr>
          </thead>
          <tbody id="jobs"></tbody>
        </table>
      </div>
    </div>

    <script>
      let accessToken = localStorage.getItem("accessToken") || "";

      function getCsrf() {
        const m = document.cookie.match(/(?:^|;\\s*)csrf=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : "";
      }

      function authHeaders(extra = {}) {
        const h = { ...extra };
        if (accessToken) h["Authorization"] = `Bearer ${accessToken}`;
        return h;
      }

      const jobSel = document.getElementById("job");
      const srcEl = document.getElementById("source");
      const player = document.getElementById("player");

      function setSource(job) {
        const url = accessToken ? `/video/${encodeURIComponent(job)}?token=${encodeURIComponent(accessToken)}` : `/video/${encodeURIComponent(job)}`;
        srcEl.src = url;
        player.load();
      }

      jobSel.addEventListener("change", () => setSource(jobSel.value));
      if (jobSel.value) setSource(jobSel.value);

      const statusEl = document.getElementById("status");
      const barEl = document.getElementById("bar");
      const jobsTbody = document.getElementById("jobs");

      function setProgress(p, msg) {
        const pct = Math.max(0, Math.min(1, p || 0)) * 100;
        barEl.style.width = `${pct}%`;
        statusEl.textContent = msg || "";
      }

      async function refreshJobs() {
        const res = await fetch(`/api/jobs`, { headers: authHeaders() });
        if (!res.ok) return;
        const payload = await res.json();
        const jobs = Array.isArray(payload) ? payload : (payload.items || []);
        jobsTbody.innerHTML = "";
        for (const j of jobs) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="padding:6px; font-family: monospace;">${j.id.slice(0, 8)}…</td>
            <td style="padding:6px;">${j.state}</td>
            <td style="padding:6px;">${Math.round((j.progress||0)*100)}%</td>
            <td style="padding:6px;">
              ${(j.state === "RUNNING" || j.state === "QUEUED") ? `<button data-cancel="${j.id}">Cancel</button>` : ""}
              ${(j.state === "DONE" && j.output_mkv) ? `<button data-play="${j.id}">Play</button>` : ""}
              <a href="/api/jobs/${j.id}/logs/tail" target="_blank" rel="noreferrer">logs</a>
            </td>
          `;
          jobsTbody.appendChild(tr);
        }
      }

      jobsTbody.addEventListener("click", async (ev) => {
        const btn = ev.target;
        if (btn.dataset && btn.dataset.cancel) {
          await fetch(`/api/jobs/${btn.dataset.cancel}/cancel`, { method: "POST", headers: authHeaders({ "X-CSRF-Token": getCsrf() }) });
          await refreshJobs();
        }
        if (btn.dataset && btn.dataset.play) {
          setSource(btn.dataset.play);
        }
      });

      let ws = null;
      function subscribe(jobId) {
        try { if (ws) ws.close(); } catch(e) {}
        const proto = location.protocol === "https:" ? "wss" : "ws";
        const qs = accessToken ? `?token=${encodeURIComponent(accessToken)}` : "";
        ws = new WebSocket(`${proto}://${location.host}/ws/jobs/${encodeURIComponent(jobId)}${qs}`);
        ws.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            setProgress(data.progress, `${data.state}: ${data.message || ""}`);
            if (data.state === "DONE" || data.state === "FAILED" || data.state === "CANCELED") {
              refreshJobs();
            }
          } catch(e) {}
        };
      }

      document.getElementById("submit").addEventListener("click", async () => {
        const csrf = getCsrf();
        const mode = document.getElementById("mode").value;
        const device = document.getElementById("device").value;
        const src_lang = document.getElementById("src_lang").value;
        const tgt_lang = document.getElementById("tgt_lang").value;
        const vp = document.getElementById("video_path").value.trim();
        const file = document.getElementById("file").files[0];

        let res;
        if (file) {
          const fd = new FormData();
          fd.append("file", file);
          fd.append("mode", mode);
          fd.append("device", device);
          fd.append("src_lang", src_lang);
          fd.append("tgt_lang", tgt_lang);
          res = await fetch(`/api/jobs`, { method: "POST", body: fd, headers: authHeaders({ "X-CSRF-Token": csrf }) });
        } else {
          res = await fetch(`/api/jobs`, {
            method: "POST",
            headers: authHeaders({ "content-type": "application/json", "X-CSRF-Token": csrf }),
            body: JSON.stringify({ video_path: vp, mode, device, src_lang, tgt_lang }),
          });
        }
        if (!res.ok) {
          setProgress(0, `submit failed (${res.status})`);
          return;
        }
        const data = await res.json();
        setProgress(0, `QUEUED: ${data.id}`);
        subscribe(data.id);
        await refreshJobs();
      });

      refreshJobs();
      setInterval(refreshJobs, 5000);

      // WebRTC demo link (token propagated if provided)
      const webrtcLink = document.getElementById("webrtcLink");
      if (webrtcLink) {
        webrtcLink.addEventListener("click", (ev) => {
          if (accessToken) webrtcLink.href = `/webrtc/demo?token=${encodeURIComponent(accessToken)}`;
        });
      }

      document.getElementById("login").addEventListener("click", async () => {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        const totp = document.getElementById("totp").value.trim();
        const session = document.getElementById("useSession").checked;
        const res = await fetch("/auth/login", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ username, password, totp: totp || undefined, session }),
        });
        if (!res.ok) {
          setProgress(0, `login failed (${res.status})`);
          return;
        }
        const data = await res.json();
        accessToken = data.access_token || "";
        localStorage.setItem("accessToken", accessToken);
        setProgress(0, `logged in (${data.role || "user"})`);
        refreshJobs();
        if (jobSel.value) setSource(jobSel.value);
      });
    </script>
  </body>
</html>
