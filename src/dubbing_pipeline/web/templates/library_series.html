{% extends "_base.html" %}

{% block title %}Library • dubbing_pipeline{% endblock %}

{% block content %}
<div class="flex items-start justify-between gap-4">
  <div>
    <h1 class="text-2xl font-semibold">Library</h1>
    <p class="mt-1 text-sm text-slate-400">Browse series grouped by season and episode.</p>
  </div>
</div>

<div class="mt-6 rounded-xl border border-slate-800 bg-slate-900/40 p-4"
     x-data="librarySeries()"
     x-init="init()">
  <div class="grid gap-4 lg:grid-cols-3">
    <div class="lg:col-span-2">
      <div class="text-sm text-slate-300">Search & filters</div>
      <div class="mt-2 grid gap-2 sm:grid-cols-2 lg:grid-cols-4">
        <div>
          <label class="block text-xs text-slate-500" for="seriesSearch">Series</label>
          <input id="seriesSearch"
                 class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-sm"
                 placeholder="series title or slug"
                 x-model="q"
                 @keydown.enter.prevent="applyFilters()" />
        </div>
        <div>
          <label class="block text-xs text-slate-500" for="seasonSearch">Season</label>
          <input id="seasonSearch" type="number" min="1"
                 class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-sm"
                 placeholder="e.g. 1"
                 x-model="seasonFilter"
                 @keydown.enter.prevent="applyFilters()" />
        </div>
        <div>
          <label class="block text-xs text-slate-500" for="episodeSearch">Episode</label>
          <input id="episodeSearch" type="number" min="1"
                 class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-sm"
                 placeholder="e.g. 12"
                 x-model="episodeFilter"
                 @keydown.enter.prevent="applyFilters()" />
        </div>
        <div>
          <label class="block text-xs text-slate-500" for="statusSearch">Status</label>
          <select id="statusSearch"
                  class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-sm"
                  x-model="status"
                  @change="applyFilters()">
            <option value="">Any</option>
            <option value="has_outputs">Has outputs</option>
            <option value="in_progress">In progress</option>
            <option value="failed">Failed</option>
          </select>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap items-end gap-2">
        <div>
          <label class="block text-xs text-slate-500" for="seriesView">View</label>
          <select id="seriesView"
                  class="mt-1 rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-sm"
                  x-model="view"
                  @change="applyFilters()">
            <option value="all">My + Public</option>
            <option value="mine">My Library</option>
            <option value="public">Public Library</option>
          </select>
        </div>
        <button class="rounded-lg bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm"
                @click="applyFilters()">Apply</button>
      </div>
      <div class="mt-2 text-xs text-slate-500">Searches are scoped to what you can access.</div>
    </div>
    <div class="rounded-xl border border-slate-800 bg-slate-950/20 p-4">
      <div class="text-sm text-slate-300">Continue last series</div>
      <div class="mt-2 text-xs text-slate-500" x-show="continueLoading" x-cloak>Loading…</div>
      <template x-if="continueItem">
        <a class="mt-2 block rounded-lg border border-slate-800 bg-slate-950/30 hover:bg-slate-950/50 p-3"
           :href="'/ui/library/' + encodeURIComponent(continueItem.series_slug)">
          <div class="text-sm text-slate-200" x-text="continueItem.series_title || continueItem.series_slug"></div>
          <div class="mt-1 text-xs text-slate-500 break-all" x-text="continueItem.series_slug"></div>
        </a>
      </template>
      <div class="mt-2 text-xs text-slate-500" x-show="!continueLoading && !continueItem" x-cloak>
        No recent series yet.
      </div>
    </div>
  </div>

  <!-- Recently Dubbed -->
  <div class="mt-6 rounded-xl border border-slate-800 bg-slate-950/20 p-4">
    <div class="flex items-center justify-between gap-2">
      <div class="text-sm text-slate-300">Recently Dubbed</div>
      <button class="rounded bg-slate-800 hover:bg-slate-700 px-3 py-2 text-xs"
              @click="loadRecent()">Refresh</button>
    </div>
    <div class="mt-3 text-xs text-slate-500" x-show="recentLoading" x-cloak>Loading…</div>
    <div class="mt-3 grid gap-3 sm:grid-cols-2" x-show="!recentLoading" x-cloak>
      <template x-for="r in recentItems" :key="r.job_id">
        <a class="block rounded-lg border border-slate-800 bg-slate-950/30 hover:bg-slate-950/50 p-3"
           :href="'/ui/library/' + encodeURIComponent(r.series_slug) + '/season/' + encodeURIComponent(r.season_number) + '/episode/' + encodeURIComponent(r.episode_number)">
          <div class="text-sm text-slate-200" x-text="r.series_title || r.series_slug"></div>
          <div class="mt-1 text-xs text-slate-500">
            <span x-text="'S' + r.season_number + ' • E' + r.episode_number"></span>
            <span class="mx-1">•</span>
            <span x-text="r.status || ''"></span>
          </div>
          <div class="mt-1 text-xs text-slate-500" x-text="r.updated_at || ''"></div>
        </a>
      </template>
    </div>
    <div class="mt-3 text-xs text-slate-500" x-show="!recentLoading && recentItems.length===0" x-cloak>
      No recent jobs found.
    </div>
  </div>

  <!-- Search results -->
  <div class="mt-6 rounded-xl border border-slate-800 bg-slate-950/20 p-4" x-show="hasSearch()" x-cloak>
    <div class="text-sm text-slate-300">Search results</div>
    <div class="mt-3 text-xs text-slate-500" x-show="searchLoading" x-cloak>Loading…</div>
    <div class="mt-3 overflow-x-auto" x-show="!searchLoading" x-cloak>
      <table class="min-w-full text-sm">
        <thead class="text-xs text-slate-500">
          <tr>
            <th class="text-left py-2 pr-3">Series</th>
            <th class="text-left py-2 pr-3">Season</th>
            <th class="text-left py-2 pr-3">Episode</th>
            <th class="text-left py-2 pr-3">Status</th>
            <th class="text-left py-2 pr-3">Updated</th>
            <th class="text-left py-2 pr-3"></th>
          </tr>
        </thead>
        <tbody>
          <template x-for="s in searchItems" :key="s.job_id">
            <tr class="border-t border-slate-900">
              <td class="py-2 pr-3 text-slate-200">
                <div x-text="s.series_title || s.series_slug"></div>
                <div class="text-xs text-slate-500 break-all" x-text="s.series_slug"></div>
              </td>
              <td class="py-2 pr-3 text-slate-200" x-text="s.season_number"></td>
              <td class="py-2 pr-3 text-slate-200" x-text="s.episode_number"></td>
              <td class="py-2 pr-3 text-slate-300" x-text="s.status || ''"></td>
              <td class="py-2 pr-3 text-slate-500 break-all" x-text="s.updated_at || ''"></td>
              <td class="py-2 pr-3">
                <a class="underline text-slate-200 hover:text-white"
                   :href="'/ui/library/' + encodeURIComponent(s.series_slug) + '/season/' + encodeURIComponent(s.season_number) + '/episode/' + encodeURIComponent(s.episode_number)">
                  View
                </a>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
    <div class="mt-3 text-xs text-slate-500" x-show="!searchLoading && searchItems.length===0" x-cloak>
      No matches.
    </div>
  </div>

  <div class="mt-6 flex flex-wrap items-end justify-between gap-3">
    <div class="flex flex-col gap-2">
      <div class="text-sm text-slate-300">Series</div>
      <div class="text-xs text-slate-500">Ordering comes from the server; private jobs are never shown to other users.</div>
    </div>
  </div>

  <div class="mt-4" x-show="loadingSeries" x-cloak>
    <div class="text-sm text-slate-500">Loading…</div>
  </div>

  <div class="mt-4 grid gap-3 sm:grid-cols-2" x-show="!loadingSeries" x-cloak>
    <template x-for="s in items" :key="s.series_slug">
      <a class="block rounded-xl border border-slate-800 bg-slate-950/30 hover:bg-slate-950/50 p-4"
         :href="'/ui/library/' + encodeURIComponent(s.series_slug)">
        <div class="text-base font-semibold" x-text="s.series_title"></div>
        <div class="mt-1 text-xs text-slate-500 break-all" x-text="s.series_slug"></div>
        <div class="mt-3 flex flex-wrap gap-3 text-sm text-slate-300">
          <div><span class="text-slate-500">Seasons:</span> <span x-text="s.seasons_count"></span></div>
          <div><span class="text-slate-500">Episodes:</span> <span x-text="s.episodes_count"></span></div>
        </div>
        <div class="mt-2 text-xs text-slate-500" x-show="s.latest_updated_at" x-text="'Updated: ' + s.latest_updated_at"></div>
      </a>
    </template>
  </div>

  <div class="mt-4 text-sm text-slate-500" x-show="!loadingSeries && items.length===0" x-cloak>
    No series found.
  </div>

  <div class="mt-4 flex items-center justify-between gap-3" x-show="!loadingSeries && items.length>0" x-cloak>
    <div class="text-xs text-slate-500">Showing <span x-text="items.length"></span> items</div>
    <div class="flex items-center gap-2">
      <button class="rounded bg-slate-800 hover:bg-slate-700 px-3 py-2 text-sm"
              @click="loadMore()" :disabled="busy">Load more</button>
    </div>
  </div>
</div>

<script>
  function librarySeries() {
    return {
      q: "",
      seasonFilter: "",
      episodeFilter: "",
      status: "",
      view: "all",
      limit: 50,
      offset: 0,
      items: [],
      searchItems: [],
      recentItems: [],
      continueItem: null,
      loadingSeries: true,
      searchLoading: false,
      recentLoading: true,
      continueLoading: true,
      busy: false,
      hasSearch() {
        return !!(this.q || this.seasonFilter || this.episodeFilter || this.status);
      },
      async init() {
        try {
          const url = new URL(window.location.href);
          this.q = url.searchParams.get("q") || "";
          this.seasonFilter = url.searchParams.get("season") || "";
          this.episodeFilter = url.searchParams.get("episode") || "";
          this.status = url.searchParams.get("status") || "";
          this.view = url.searchParams.get("view") || "all";
        } catch (e) {}
        await Promise.all([
          this.loadContinue(),
          this.loadRecent(),
          this.reloadSeries(true),
          this.search(true)
        ]);
      },
      async applyFilters() {
        await Promise.all([this.reloadSeries(true), this.search(true), this.loadRecent()]);
        try {
          const u = new URL(window.location.href);
          if (this.q) u.searchParams.set("q", this.q); else u.searchParams.delete("q");
          if (this.seasonFilter) u.searchParams.set("season", this.seasonFilter); else u.searchParams.delete("season");
          if (this.episodeFilter) u.searchParams.set("episode", this.episodeFilter); else u.searchParams.delete("episode");
          if (this.status) u.searchParams.set("status", this.status); else u.searchParams.delete("status");
          if (this.view && this.view !== "all") u.searchParams.set("view", this.view); else u.searchParams.delete("view");
          window.history.replaceState({}, "", u.toString());
        } catch (e) {}
      },
      async reloadSeries(reset) {
        if (this.busy) return;
        this.busy = true;
        if (reset) {
          this.offset = 0;
          this.items = [];
          this.loadingSeries = true;
        }
        try {
          const url = "/api/library/series"
            + "?limit=" + encodeURIComponent(this.limit)
            + "&offset=" + encodeURIComponent(this.offset)
            + "&order=title"
            + (this.q ? ("&q=" + encodeURIComponent(this.q)) : "")
            + (this.status ? ("&status=" + encodeURIComponent(this.status)) : "")
            + (this.view ? ("&view=" + encodeURIComponent(this.view)) : "");
          const r = await fetch(url, { credentials: "include" });
          if (!r.ok) throw new Error("failed (" + r.status + ")");
          const data = await r.json();
          if (Array.isArray(data)) {
            this.items = this.items.concat(data);
            this.offset = this.items.length;
          }
        } catch (e) {
          window.showToast("Failed to load series", "error");
        } finally {
          this.loadingSeries = false;
          this.busy = false;
        }
      },
      async loadMore() {
        await this.reloadSeries(false);
      },
      async search(reset) {
        if (!this.hasSearch()) {
          this.searchItems = [];
          this.searchLoading = false;
          return;
        }
        this.searchLoading = true;
        if (reset) this.searchItems = [];
        try {
          const url = "/api/library/search"
            + "?limit=" + encodeURIComponent(100)
            + "&offset=0"
            + (this.q ? ("&q=" + encodeURIComponent(this.q)) : "")
            + (this.seasonFilter ? ("&season_number=" + encodeURIComponent(this.seasonFilter)) : "")
            + (this.episodeFilter ? ("&episode_number=" + encodeURIComponent(this.episodeFilter)) : "")
            + (this.status ? ("&status=" + encodeURIComponent(this.status)) : "")
            + (this.view ? ("&view=" + encodeURIComponent(this.view)) : "");
          const r = await fetch(url, { credentials: "include" });
          if (!r.ok) throw new Error("failed (" + r.status + ")");
          const data = await r.json();
          this.searchItems = Array.isArray(data.items) ? data.items : [];
        } catch (e) {
          window.showToast("Failed to search library", "error");
          this.searchItems = [];
        } finally {
          this.searchLoading = false;
        }
      },
      async loadRecent() {
        this.recentLoading = true;
        try {
          const url = "/api/library/recent?limit=8"
            + (this.view ? ("&view=" + encodeURIComponent(this.view)) : "");
          const r = await fetch(url, { credentials: "include" });
          if (!r.ok) throw new Error("failed (" + r.status + ")");
          const data = await r.json();
          this.recentItems = Array.isArray(data.items) ? data.items : [];
        } catch (e) {
          this.recentItems = [];
        } finally {
          this.recentLoading = false;
        }
      },
      async loadContinue() {
        this.continueLoading = true;
        try {
          const r = await fetch("/api/library/continue", { credentials: "include" });
          if (!r.ok) throw new Error("failed (" + r.status + ")");
          const data = await r.json();
          this.continueItem = data && data.item ? data.item : null;
        } catch (e) {
          this.continueItem = null;
        } finally {
          this.continueLoading = false;
        }
      }
    };
  }
</script>
{% endblock %}

