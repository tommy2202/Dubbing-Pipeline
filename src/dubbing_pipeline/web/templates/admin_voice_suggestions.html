{% extends "_base.html" %}

{% block title %}Voice Suggestions • Admin • dubbing_pipeline{% endblock %}

{% block content %}
<div class="flex items-start justify-between gap-4">
  <div>
    <div class="text-xs text-slate-500">Admin / Voice suggestions</div>
    <h1 class="mt-1 text-2xl font-semibold">Voice similarity suggestions</h1>
    <p class="mt-1 text-sm text-slate-400">Review cross-series suggestions before approving merges.</p>
  </div>
</div>

<div class="mt-6 rounded-xl border border-slate-800 bg-slate-900/40 p-4"
     x-data="voiceSuggestionsAdmin()" x-init="load()">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="text-sm text-slate-300">Suggestions</div>
    <div class="flex items-center gap-2">
      <label class="text-xs text-slate-500" for="statusSel">Status</label>
      <select id="statusSel" class="rounded bg-slate-950 border border-slate-800 px-2 py-1 text-sm"
              x-model="status" @change="load()">
        <option value="pending">pending</option>
        <option value="accepted">accepted</option>
        <option value="approved">approved</option>
        <option value="rejected">rejected</option>
        <option value="all">all</option>
      </select>
      <button type="button" class="rounded bg-slate-800 hover:bg-slate-700 px-3 py-2 text-sm"
              @click="load()" :disabled="busy">Refresh</button>
    </div>
  </div>

  <div class="mt-3 text-sm text-red-200" role="alert" aria-live="polite" x-show="error" x-cloak x-text="error"></div>

  <div class="mt-4 overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="text-xs text-slate-500">
        <tr>
          <th class="text-left py-2 pr-3">profile</th>
          <th class="text-left py-2 pr-3">suggested</th>
          <th class="text-left py-2 pr-3">similarity</th>
          <th class="text-left py-2 pr-3">status</th>
          <th class="text-left py-2 pr-3">created</th>
          <th class="text-left py-2 pr-3">action</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="it in items" :key="it.id">
          <tr class="border-t border-slate-900">
            <td class="py-2 pr-3">
              <div class="font-mono text-xs" x-text="it.profile_id"></div>
              <div class="text-xs text-slate-400" x-text="it.profile_display_name || ''"></div>
              <div class="text-[11px] text-slate-500" x-text="it.profile_series_lock ? ('series: ' + it.profile_series_lock) : 'series: (global)'"></div>
            </td>
            <td class="py-2 pr-3">
              <div class="font-mono text-xs" x-text="it.suggested_profile_id"></div>
              <div class="text-xs text-slate-400" x-text="it.suggested_display_name || ''"></div>
              <div class="text-[11px] text-slate-500" x-text="it.suggested_series_lock ? ('series: ' + it.suggested_series_lock) : ('scope: ' + (it.suggested_scope || 'global'))"></div>
            </td>
            <td class="py-2 pr-3">
              <span class="text-xs text-slate-200" x-text="Math.round(Number(it.similarity || 0) * 100) + '%'"></span>
            </td>
            <td class="py-2 pr-3">
              <span class="rounded bg-slate-900/60 border border-slate-800 px-2 py-1 text-xs text-slate-200"
                    x-text="it.status"></span>
            </td>
            <td class="py-2 pr-3 text-xs text-slate-400" x-text="fmtTime(it.created_at)"></td>
            <td class="py-2 pr-3">
              <button class="rounded bg-emerald-700/30 hover:bg-emerald-700/40 border border-emerald-700/50 px-3 py-2 text-xs text-emerald-100 disabled:opacity-50"
                      :disabled="busy || it.status !== 'accepted'"
                      @click="approve(it.id)">
                Approve merge
              </button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>
  <div class="mt-3 text-sm text-slate-500" x-show="!items.length && !busy" x-cloak>No suggestions found.</div>
</div>

<script>
  function voiceSuggestionsAdmin() {
    return {
      items: [],
      status: "pending",
      busy: false,
      error: "",
      fmtTime(ts) {
        const n = Number(ts || 0);
        if (!Number.isFinite(n) || n <= 0) return "";
        try { return new Date(n * 1000).toLocaleString(); } catch (e) { return ""; }
      },
      async load() {
        this.busy = true;
        this.error = "";
        try {
          const r = await fetch("/api/admin/voices/suggestions?status=" + encodeURIComponent(this.status), { credentials: "include" });
          const d = await r.json().catch(() => ({}));
          if (!r.ok) {
            this.error = d.detail || ("Load failed (" + r.status + ")");
            this.items = [];
            return;
          }
          this.items = Array.isArray(d.items) ? d.items : [];
        } catch (e) {
          this.error = "Load failed";
          this.items = [];
        } finally {
          this.busy = false;
        }
      },
      async approve(id) {
        if (!confirm("Approve merge for this suggestion?")) return;
        this.busy = true;
        try {
          const csrf = document.getElementById("csrf")?.value || "";
          const r = await fetch("/api/admin/voices/approve_merge", {
            method: "POST",
            credentials: "include",
            headers: { "content-type": "application/json", "X-CSRF-Token": csrf },
            body: JSON.stringify({ suggestion_id: String(id || "") }),
          });
          const d = await r.json().catch(() => ({}));
          if (!r.ok) {
            this.error = d.detail || ("Approve failed (" + r.status + ")");
            return;
          }
          try { window.showToast("Merge approved", "success"); } catch (e) {}
          await this.load();
        } catch (e) {
          this.error = "Approve failed";
        } finally {
          this.busy = false;
        }
      },
    };
  }
</script>
{% endblock %}
