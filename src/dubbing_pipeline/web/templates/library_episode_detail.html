{% extends "_base.html" %}

{% block title %}{{ series_slug }} S{{ '%02d'|format(season_number) }}E{{ '%02d'|format(episode_number) }} • Library • dubbing_pipeline{% endblock %}

{% block content %}
<div class="flex items-start justify-between gap-4">
  <div>
    <div class="text-xs text-slate-500">
      <a class="underline" href="/ui/library">Library</a>
      / <a class="underline break-all" href="/ui/library/{{ series_slug }}">{{ series_slug }}</a>
      / <a class="underline" href="/ui/library/{{ series_slug }}/season/{{ season_number }}">season {{ season_number }}</a>
      / episode {{ episode_number }}
    </div>
    <h1 class="mt-1 text-2xl font-semibold">Episode {{ episode_number }}</h1>
    <p class="mt-1 text-sm text-slate-400">Playback and versions (newest first).</p>
  </div>
</div>

<div class="mt-6 grid gap-4 lg:grid-cols-3"
     x-data="libraryEpisodeDetail('{{ series_slug }}', {{ season_number }}, {{ episode_number }})"
     x-init="init()">

  <!-- Playback -->
  <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4 lg:col-span-2">
    <div class="flex items-center justify-between gap-2">
      <div class="text-sm text-slate-300">Playback</div>
      <a class="text-sm underline text-slate-300 hover:text-white" :href="selectedJobId ? ('/ui/jobs/' + encodeURIComponent(selectedJobId)) : '#'"
         :class="selectedJobId ? '' : 'pointer-events-none opacity-60'">Open job</a>
    </div>
    <div class="mt-2 text-xs text-slate-500" x-text="selectedJobId ? ('Job: ' + selectedJobId) : 'Loading…'"></div>

    <div class="mt-4 flex flex-wrap gap-2">
      <a class="rounded bg-indigo-600 hover:bg-indigo-500 px-4 py-3 text-sm font-medium"
         :class="!playback.master ? 'pointer-events-none opacity-50' : ''"
         :href="playback.master || '#'"
         target="_blank" rel="noreferrer">Master</a>
      <a class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm"
         :class="!playback.mobile ? 'pointer-events-none opacity-50' : ''"
         :href="playback.mobile || '#'"
         target="_blank" rel="noreferrer">Mobile MP4</a>
      <a class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm"
         :class="!playback.hls ? 'pointer-events-none opacity-50' : ''"
         :href="playback.hls || '#'"
         target="_blank" rel="noreferrer">HLS</a>
      <button class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm"
              @click="loadFiles()"
              :disabled="!selectedJobId || busy">Refresh files</button>
    </div>

    <div class="mt-4 grid gap-3 sm:grid-cols-2">
      <div class="rounded-lg border border-slate-800 bg-slate-950/30 p-3">
        <div class="text-xs text-slate-500">QA</div>
        <div class="mt-2">
          <a class="underline text-slate-200 hover:text-white"
             :class="!qaUrl ? 'pointer-events-none opacity-50' : ''"
             :href="qaUrl || '#'"
             target="_blank" rel="noreferrer">Open QA report</a>
          <div class="mt-2">
            <a class="underline text-slate-200 hover:text-white"
               :class="!selectedJobId ? 'pointer-events-none opacity-50' : ''"
               :href="selectedJobId ? ('/ui/jobs/' + encodeURIComponent(selectedJobId)) : '#'"
            >Open job QA tab</a>
          </div>
          <div class="mt-1 text-xs text-slate-500" x-text="qaUrl ? qaUrl : 'No QA report found.'"></div>
        </div>
      </div>
      <div class="rounded-lg border border-slate-800 bg-slate-950/30 p-3">
        <div class="text-xs text-slate-500">Visibility</div>
        <div class="mt-2 text-sm text-slate-200" x-text="selectedVisibility || ''"></div>
      </div>
    </div>
  </div>

  <!-- Versions -->
  <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
    <div class="flex items-center justify-between gap-2">
      <div class="text-sm text-slate-300">Versions</div>
      <div class="text-xs text-slate-500" x-text="versions.length ? (versions.length + ' total') : ''"></div>
    </div>
    <div class="mt-2 text-xs text-slate-500">Newest version is selected by default.</div>

    <div class="mt-3 space-y-2">
      <template x-for="v in versions" :key="v.job_id">
        <button type="button"
                class="w-full text-left rounded-lg border px-3 py-3"
                :class="selectedJobId===v.job_id ? 'border-indigo-600 bg-indigo-900/20' : 'border-slate-800 bg-slate-950/30 hover:bg-slate-950/50'"
                @click="select(v)">
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-sm font-medium break-all" x-text="v.job_id"></div>
              <div class="mt-1 text-xs text-slate-500" x-text="v.created_at || ''"></div>
            </div>
            <div class="text-xs text-slate-300" x-text="v.status || ''"></div>
          </div>
        </button>
      </template>
    </div>

    <div class="mt-4 text-sm text-slate-500" x-show="!loading && versions.length===0" x-cloak>
      No versions found.
    </div>
  </div>
</div>

<script>
  function libraryEpisodeDetail(seriesSlug, seasonNumber, episodeNumber) {
    return {
      seriesSlug,
      seasonNumber,
      episodeNumber,
      view: "all",
      loading: true,
      busy: false,
      versions: [],
      selectedJobId: "",
      selectedVisibility: "",
      playback: { master: null, mobile: null, hls: null },
      qaUrl: "",
      async init() {
        try {
          const url = new URL(window.location.href);
          this.view = url.searchParams.get("view") || "all";
        } catch (e) {}
        await this.touchContinue();
        await this.loadVersions();
      },
      async touchContinue() {
        try {
          await fetch("/api/library/continue", {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": "{{ csrf_token }}"
            },
            body: JSON.stringify({
              series_slug: this.seriesSlug,
              series_title: this.seriesSlug
            })
          });
        } catch (e) {}
      },
      async loadVersions() {
        this.loading = true;
        try {
          const url = "/api/library/" + encodeURIComponent(this.seriesSlug)
            + "/" + encodeURIComponent(this.seasonNumber)
            + "/episodes?episode_number=" + encodeURIComponent(this.episodeNumber)
            + "&include_versions=1"
            + (this.view ? ("&view=" + encodeURIComponent(this.view)) : "");
          const r = await fetch(url, { credentials: "include" });
          if (!r.ok) throw new Error("failed (" + r.status + ")");
          const data = await r.json();
          this.versions = Array.isArray(data) ? data : [];
          if (this.versions.length) {
            this.select(this.versions[0]);
          }
        } catch (e) {
          window.showToast("Failed to load versions", "error");
          this.versions = [];
        } finally {
          this.loading = false;
        }
      },
      async select(v) {
        this.selectedJobId = v.job_id || "";
        this.selectedVisibility = v.visibility || "";
        // Prefer playback_urls if provided.
        const pu = v.playback_urls || {};
        this.playback.master = pu.master || null;
        this.playback.mobile = pu.mobile || null;
        this.playback.hls = pu.hls_index || null;
        this.qaUrl = "";
        // Fill in missing URLs by querying job files (best-effort).
        await this.loadFiles();
      },
      async loadFiles() {
        if (!this.selectedJobId) return;
        if (this.busy) return;
        this.busy = true;
        try {
          const r = await fetch("/api/jobs/" + encodeURIComponent(this.selectedJobId) + "/files", { credentials: "include" });
          if (!r.ok) throw new Error("failed (" + r.status + ")");
          const data = await r.json();
          const files = (data && data.files && Array.isArray(data.files)) ? data.files : [];
          function firstUrl(kind) {
            const it = files.find((x) => x && x.kind === kind);
            return it && it.url ? it.url : null;
          }
          // Playback URLs
          if (!this.playback.master) this.playback.master = firstUrl("mkv") || firstUrl("mp4");
          if (!this.playback.mobile) this.playback.mobile = firstUrl("mobile_mp4");
          if (!this.playback.hls) this.playback.hls = firstUrl("mobile_hls_manifest") || firstUrl("hls_manifest");
          // QA: prefer top markdown then summary JSON if present
          this.qaUrl = firstUrl("qa_top_md") || firstUrl("qa_summary") || "";
        } catch (e) {
          // Silent-ish: keep whatever we have from library endpoint.
        } finally {
          this.busy = false;
        }
      }
    };
  }
</script>
{% endblock %}

