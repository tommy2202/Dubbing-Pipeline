{% extends "_base.html" %}

{% block title %}Voice {{ voice_id }} • {{ series_slug }} • dubbing_pipeline{% endblock %}

{% block content %}
<div class="flex items-start justify-between gap-4">
  <div>
    <div class="text-xs text-slate-500">
      <a class="underline" href="/ui/library">Library</a>
      / <a class="underline break-all" href="/ui/library/{{ series_slug }}">{{ series_slug }}</a>
      / voice {{ voice_id }}
    </div>
    <h1 class="mt-1 text-2xl font-semibold">Voice {{ voice_id }}</h1>
    <p class="mt-1 text-sm text-slate-400">Version history, drift warnings, and rollback.</p>
  </div>
</div>

<div class="mt-6 grid gap-4 lg:grid-cols-3"
     x-data="voiceDetail('{{ series_slug }}', '{{ voice_id }}')"
     x-init="init()">

  <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4 lg:col-span-2">
    <div class="flex items-center justify-between gap-2">
      <div class="text-sm text-slate-300">Current ref</div>
      <button type="button" class="rounded bg-slate-800 hover:bg-slate-700 px-3 py-2 text-sm"
              @click="loadVersions()" :disabled="busy">Refresh</button>
    </div>
    <div class="mt-2 text-xs text-slate-500" x-text="displayName ? displayName : ('Series: ' + seriesSlug)"></div>
    <div class="mt-3">
      <template x-if="audioUrl">
        <audio class="w-full" controls preload="none" :src="audioUrl"></audio>
      </template>
      <template x-if="!audioUrl">
        <div class="text-sm text-slate-500">No ref audio uploaded yet.</div>
      </template>
    </div>
  </div>

  <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
    <div class="text-sm text-slate-300">Status</div>
    <div class="mt-2 text-xs text-slate-500">Current version</div>
    <div class="mt-1 text-2xl font-semibold" x-text="currentVersion ? ('v' + currentVersion) : '—'"></div>
    <div class="mt-3 text-sm text-red-200" role="alert" aria-live="polite" x-show="error" x-cloak x-text="error"></div>
  </div>

  <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4 lg:col-span-3">
    <div class="flex items-center justify-between gap-2">
      <div class="text-sm text-slate-300">Versions</div>
      <div class="text-xs text-slate-500" x-text="versions.length ? (versions.length + ' total') : ''"></div>
    </div>
    <div class="mt-2 text-xs text-slate-500">Drift warnings appear when similarity drops below threshold.</div>

    <div class="mt-4 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-xs text-slate-500">
          <tr>
            <th class="text-left py-2 pr-3">version</th>
            <th class="text-left py-2 pr-3">created</th>
            <th class="text-left py-2 pr-3">similarity</th>
            <th class="text-left py-2 pr-3">notes</th>
            <th class="text-left py-2 pr-3">action</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="v in versions" :key="v.version">
            <tr class="border-t border-slate-900">
              <td class="py-2 pr-3">
                <span class="font-mono" x-text="'v' + v.version"></span>
                <span class="ml-2 text-xs text-emerald-200" x-show="v.version === currentVersion">current</span>
                <span class="ml-2 text-xs text-red-200" x-show="v.drifted">drift</span>
              </td>
              <td class="py-2 pr-3 text-xs text-slate-400" x-text="fmtTime(v.created_at)"></td>
              <td class="py-2 pr-3">
                <span class="text-xs text-slate-400" x-show="v.similarity === null || v.similarity === undefined">n/a</span>
                <span class="text-xs text-slate-200" x-show="v.similarity !== null && v.similarity !== undefined"
                      x-text="Math.round(Number(v.similarity || 0) * 100) + '%'"></span>
                <div class="text-xs text-red-200" x-show="v.drifted">Below threshold</div>
              </td>
              <td class="py-2 pr-3 text-xs text-slate-400" x-text="v.notes || ''"></td>
              <td class="py-2 pr-3">
                <button class="rounded bg-slate-800 hover:bg-slate-700 px-3 py-2 text-xs disabled:opacity-50"
                        :disabled="busy || v.version === currentVersion"
                        @click="rollback(v.version)">
                  Rollback
                </button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
    <div class="mt-3 text-sm text-slate-500" x-show="!versions.length && !loading" x-cloak>No versions yet.</div>
  </div>
</div>

<script>
  function voiceDetail(seriesSlug, voiceId) {
    return {
      seriesSlug,
      voiceId,
      loading: true,
      busy: false,
      error: "",
      versions: [],
      currentVersion: 0,
      displayName: "",
      audioUrl: "",
      async init() {
        await Promise.all([this.loadCharacter(), this.loadVersions()]);
      },
      fmtTime(ts) {
        const n = Number(ts || 0);
        if (!Number.isFinite(n) || n <= 0) return "";
        try { return new Date(n * 1000).toLocaleString(); } catch (e) { return ""; }
      },
      async loadCharacter() {
        try {
          const r = await fetch("/api/series/" + encodeURIComponent(this.seriesSlug) + "/characters", { credentials: "include" });
          if (!r.ok) return;
          const data = await r.json();
          const items = Array.isArray(data.items) ? data.items : [];
          const found = items.find((x) => String(x.character_slug||"") === String(this.voiceId||""));
          if (found) {
            this.displayName = String(found.display_name || "");
            this.audioUrl = String(found.audio_url || "");
          }
        } catch (e) {}
      },
      async loadVersions() {
        this.loading = true;
        this.error = "";
        try {
          const r = await fetch("/api/voices/" + encodeURIComponent(this.seriesSlug) + "/" + encodeURIComponent(this.voiceId) + "/versions", { credentials: "include" });
          const data = await r.json().catch(() => ({}));
          if (!r.ok) {
            this.error = data.detail || ("Failed (" + r.status + ")");
            this.versions = [];
            return;
          }
          this.versions = Array.isArray(data.items) ? data.items : [];
          this.currentVersion = Number(data.current_version || 0);
        } catch (e) {
          this.error = "Failed to load versions";
          this.versions = [];
        } finally {
          this.loading = false;
        }
      },
      async rollback(version) {
        if (!confirm("Rollback to v" + version + "? This creates a new version.")) return;
        this.busy = true;
        try {
          const csrf = document.getElementById("csrf")?.value || "";
          const r = await fetch("/api/voices/" + encodeURIComponent(this.seriesSlug) + "/" + encodeURIComponent(this.voiceId) + "/rollback?version=" + encodeURIComponent(version), {
            method: "POST",
            credentials: "include",
            headers: { "X-CSRF-Token": csrf }
          });
          const data = await r.json().catch(() => ({}));
          if (!r.ok) {
            this.error = data.detail || ("Rollback failed (" + r.status + ")");
            return;
          }
          await this.loadVersions();
          await this.loadCharacter();
          try { window.showToast("Rollback complete", "success"); } catch (e) {}
        } catch (e) {
          this.error = "Rollback failed";
        } finally {
          this.busy = false;
        }
      }
    };
  }
</script>
{% endblock %}
