{% extends "_base.html" %}

{% block title %}{{ series_slug }} S{{ '%02d'|format(season_number) }} • Library • dubbing_pipeline{% endblock %}

{% block content %}
<div class="flex items-start justify-between gap-4">
  <div>
    <div class="text-xs text-slate-500">
      <a class="underline" href="/ui/library">Library</a>
      / <a class="underline break-all" href="/ui/library/{{ series_slug }}">{{ series_slug }}</a>
      / season {{ season_number }}
    </div>
    <h1 class="mt-1 text-2xl font-semibold">Episodes</h1>
    <p class="mt-1 text-sm text-slate-400">Sorted numerically by episode number.</p>
  </div>
</div>

<div class="mt-6 rounded-xl border border-slate-800 bg-slate-900/40 p-4"
     x-data="libraryEpisodes('{{ series_slug }}', {{ season_number }})"
     x-init="init()">
  <div class="flex flex-wrap items-end justify-between gap-3">
    <div class="text-sm text-slate-300">
      Series: <span class="text-slate-200 break-all" x-text="seriesSlug"></span>
      <span class="text-slate-500">•</span>
      <span class="text-slate-200" x-text="'Season ' + seasonNumber"></span>
    </div>
    <div class="flex items-end gap-2">
      <div>
        <label class="block text-xs text-slate-500" for="viewSel2">View</label>
        <select id="viewSel2"
                class="mt-1 rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-sm"
                x-model="view"
                @change="reload()">
          <option value="all">My + Public</option>
          <option value="mine">My</option>
          <option value="public">Public</option>
        </select>
      </div>
    </div>
  </div>

  <div class="mt-4" x-show="loading" x-cloak>
    <div class="text-sm text-slate-500">Loading…</div>
  </div>

  <div class="mt-4 overflow-x-auto" x-show="!loading" x-cloak>
    <table class="min-w-full text-sm">
      <thead class="text-xs text-slate-500">
        <tr>
          <th class="text-left py-2 pr-3">Episode</th>
          <th class="text-left py-2 pr-3">Status</th>
          <th class="text-left py-2 pr-3">Visibility</th>
          <th class="text-left py-2 pr-3">Updated</th>
          <th class="text-left py-2 pr-3">Versions</th>
          <th class="text-left py-2 pr-3"></th>
        </tr>
      </thead>
      <tbody>
        <template x-for="e in items" :key="e.episode_number">
          <tr class="border-t border-slate-900">
            <td class="py-2 pr-3 text-slate-200" x-text="e.episode_number"></td>
            <td class="py-2 pr-3 text-slate-200" x-text="e.status || ''"></td>
            <td class="py-2 pr-3 text-slate-300" x-text="e.visibility || ''"></td>
            <td class="py-2 pr-3 text-slate-500 break-all" x-text="e.created_at || ''"></td>
            <td class="py-2 pr-3 text-slate-300" x-text="(e.versions_count || 1)"></td>
            <td class="py-2 pr-3">
              <a class="underline text-slate-200 hover:text-white"
                 :href="'/ui/library/' + encodeURIComponent(seriesSlug) + '/season/' + encodeURIComponent(seasonNumber) + '/episode/' + encodeURIComponent(e.episode_number)">
                View
              </a>
              <template x-if="e.versions_count && e.versions_count > 1">
                <span class="ml-2 text-xs text-slate-500">(multi)</span>
              </template>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>

  <div class="mt-4 text-sm text-slate-500" x-show="!loading && items.length===0" x-cloak>
    No episodes found.
  </div>
</div>

<script>
  function libraryEpisodes(seriesSlug, seasonNumber) {
    return {
      seriesSlug: seriesSlug,
      seasonNumber: seasonNumber,
      view: "all",
      items: [],
      loading: true,
      async init() {
        try {
          const url = new URL(window.location.href);
          this.view = url.searchParams.get("view") || "all";
        } catch (e) {}
        await this.reload();
      },
      async reload() {
        this.loading = true;
        try {
          const url = "/api/library/" + encodeURIComponent(this.seriesSlug) + "/" + encodeURIComponent(this.seasonNumber) + "/episodes"
            + "?limit=200&offset=0"
            + (this.view ? ("&view=" + encodeURIComponent(this.view)) : "");
          const r = await fetch(url, { credentials: "include" });
          if (!r.ok) throw new Error("failed (" + r.status + ")");
          const data = await r.json();
          this.items = Array.isArray(data) ? data : [];
          try {
            const u = new URL(window.location.href);
            if (this.view && this.view !== "all") u.searchParams.set("view", this.view); else u.searchParams.delete("view");
            window.history.replaceState({}, "", u.toString());
          } catch (e) {}
        } catch (e) {
          window.showToast("Failed to load episodes", "error");
          this.items = [];
        } finally {
          this.loading = false;
        }
      }
    };
  }
</script>
{% endblock %}

