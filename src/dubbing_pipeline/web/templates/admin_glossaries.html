{% extends "_base.html" %}

{% block title %}Admin Glossaries • dubbing_pipeline{% endblock %}

{% block content %}
<div class="flex items-start justify-between gap-4">
  <div>
    <h1 class="text-2xl font-semibold">Glossaries</h1>
    <p class="mt-1 text-sm text-slate-400">Deterministic replacements by language pair and series.</p>
  </div>
  <button class="rounded-lg bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm" onclick="loadGlossaries()">Refresh</button>
</div>

<div class="mt-4 grid gap-4 lg:grid-cols-3">
  <div class="lg:col-span-2 rounded-xl border border-slate-800 bg-slate-900/40 p-4">
    <div class="flex flex-wrap items-center gap-3">
      <div>
        <label class="block text-xs text-slate-500" for="glLang">Language pair</label>
        <input id="glLang" class="mt-1 w-40 rounded bg-slate-950 border border-slate-800 px-3 py-2 text-sm" placeholder="ja->en" />
      </div>
      <div>
        <label class="block text-xs text-slate-500" for="glSeries">Series slug</label>
        <input id="glSeries" class="mt-1 w-40 rounded bg-slate-950 border border-slate-800 px-3 py-2 text-sm" placeholder="tensura" />
      </div>
      <button class="mt-5 rounded bg-slate-800 hover:bg-slate-700 px-4 py-2 text-sm" onclick="loadGlossaries()">Filter</button>
      <div id="glossaryMsg" class="text-xs text-slate-400"></div>
    </div>
    <div class="mt-4 space-y-2 text-sm" id="glossaryList"></div>
  </div>

  <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
    <div class="text-sm text-slate-300">Create / Edit</div>
    <div class="mt-3 space-y-3 text-sm">
      <div>
        <label class="block text-xs text-slate-500" for="glId">ID</label>
        <input id="glId" class="mt-1 w-full rounded bg-slate-950 border border-slate-800 px-3 py-2" placeholder="(auto)" />
      </div>
      <div>
        <label class="block text-xs text-slate-500" for="glName">Name</label>
        <input id="glName" class="mt-1 w-full rounded bg-slate-950 border border-slate-800 px-3 py-2" placeholder="Tensura main" />
      </div>
      <div class="grid gap-2 grid-cols-2">
        <div>
          <label class="block text-xs text-slate-500" for="glLang2">Language pair</label>
          <input id="glLang2" class="mt-1 w-full rounded bg-slate-950 border border-slate-800 px-3 py-2" placeholder="ja->en" />
        </div>
        <div>
          <label class="block text-xs text-slate-500" for="glSeries2">Series slug</label>
          <input id="glSeries2" class="mt-1 w-full rounded bg-slate-950 border border-slate-800 px-3 py-2" placeholder="(optional)" />
        </div>
      </div>
      <div class="grid gap-2 grid-cols-2">
        <div>
          <label class="block text-xs text-slate-500" for="glPriority">Priority</label>
          <input id="glPriority" class="mt-1 w-full rounded bg-slate-950 border border-slate-800 px-3 py-2" placeholder="0" />
        </div>
        <div class="flex items-center gap-2 mt-6">
          <input id="glEnabled" type="checkbox" class="h-4 w-4" checked />
          <label class="text-xs text-slate-300" for="glEnabled">Enabled</label>
        </div>
      </div>
      <div>
        <label class="block text-xs text-slate-500" for="glRules">Rules JSON</label>
        <textarea id="glRules" class="mt-1 w-full min-h-[160px] rounded bg-slate-950 border border-slate-800 px-3 py-2 font-mono text-xs text-slate-100"
          placeholder='{"rules":[{"kind":"exact","source":"リムル","target":"Rimuru"},{"kind":"regex","pattern":"\\bLord\\b","replace":"Lord (title)","flags":"i"}]}'></textarea>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button class="rounded bg-indigo-600 hover:bg-indigo-500 px-4 py-2 text-sm" onclick="saveGlossary()">Save</button>
        <button class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-2 text-sm" onclick="clearGlossaryForm()">Clear</button>
        <div id="glossaryFormMsg" class="text-xs text-slate-400"></div>
      </div>
    </div>
  </div>
</div>

<script>
  let _glossaries = [];

  function esc(s) {
    return String(s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function _jsonPretty(obj) {
    try { return JSON.stringify(obj, null, 2); } catch (e) { return ""; }
  }

  function clearGlossaryForm() {
    document.getElementById("glId").value = "";
    document.getElementById("glName").value = "";
    document.getElementById("glLang2").value = "";
    document.getElementById("glSeries2").value = "";
    document.getElementById("glPriority").value = "0";
    document.getElementById("glEnabled").checked = true;
    document.getElementById("glRules").value = "";
    document.getElementById("glossaryFormMsg").textContent = "";
  }

  function renderGlossaryItem(it) {
    const gid = esc(it.id);
    const name = esc(it.name);
    const lp = esc(it.language_pair);
    const series = esc(it.series_slug || "");
    const enabled = !!it.enabled;
    const pr = Number(it.priority || 0);
    const rules = it.rules_json ? _jsonPretty(it.rules_json) : "";
    return `
      <div class="rounded-lg border border-slate-800 bg-slate-950/20 p-3">
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <div class="text-slate-200 font-medium truncate">${name}</div>
            <div class="mt-1 text-xs text-slate-500">
              <span>${lp}</span>
              ${series ? `<span class="ml-2">series:</span> <span>${series}</span>` : ``}
              <span class="ml-2">priority:</span> <span>${pr}</span>
              <span class="ml-2">enabled:</span> <span>${enabled ? "yes" : "no"}</span>
            </div>
          </div>
          <div class="shrink-0 flex items-center gap-2">
            <button class="rounded bg-slate-800 hover:bg-slate-700 px-3 py-2 text-xs" onclick="editGlossary('${gid}')">Edit</button>
            <button class="rounded bg-red-900/40 hover:bg-red-900/60 px-3 py-2 text-xs text-red-100" onclick="deleteGlossary('${gid}')">Delete</button>
          </div>
        </div>
        <details class="mt-2">
          <summary class="cursor-pointer text-xs text-slate-400">Rules</summary>
          <pre class="mt-2 whitespace-pre-wrap text-xs text-slate-300">${esc(rules)}</pre>
        </details>
      </div>
    `;
  }

  async function loadGlossaries() {
    const csrf = document.getElementById("csrf")?.value || "";
    const lang = document.getElementById("glLang").value.trim();
    const series = document.getElementById("glSeries").value.trim();
    const qs = new URLSearchParams();
    if (lang) qs.set("language_pair", lang);
    if (series) qs.set("series_slug", series);
    const r = await fetch("/api/admin/glossaries?" + qs.toString(), { headers: { "X-CSRF-Token": csrf } });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) {
      document.getElementById("glossaryMsg").textContent = data.detail || ("Load failed (" + r.status + ")");
      return;
    }
    _glossaries = Array.isArray(data.items) ? data.items : [];
    document.getElementById("glossaryMsg").textContent = `${_glossaries.length} glossaries`;
    document.getElementById("glossaryList").innerHTML = _glossaries.map(renderGlossaryItem).join("");
  }

  function editGlossary(id) {
    const it = _glossaries.find(x => String(x.id) === String(id));
    if (!it) return;
    document.getElementById("glId").value = it.id || "";
    document.getElementById("glName").value = it.name || "";
    document.getElementById("glLang2").value = it.language_pair || "";
    document.getElementById("glSeries2").value = it.series_slug || "";
    document.getElementById("glPriority").value = String(it.priority || 0);
    document.getElementById("glEnabled").checked = !!it.enabled;
    document.getElementById("glRules").value = _jsonPretty(it.rules_json || { rules: [] });
    document.getElementById("glossaryFormMsg").textContent = "Editing " + String(it.id || "");
  }

  async function saveGlossary() {
    const csrf = document.getElementById("csrf")?.value || "";
    const id = document.getElementById("glId").value.trim();
    const name = document.getElementById("glName").value.trim();
    const lp = document.getElementById("glLang2").value.trim().toLowerCase();
    const series = document.getElementById("glSeries2").value.trim();
    const priority = parseInt(document.getElementById("glPriority").value.trim() || "0", 10);
    const enabled = document.getElementById("glEnabled").checked;
    let rules;
    try {
      rules = JSON.parse(document.getElementById("glRules").value.trim() || "{}");
    } catch (e) {
      document.getElementById("glossaryFormMsg").textContent = "Rules JSON invalid";
      return;
    }
    const payload = {
      id: id || undefined,
      name,
      language_pair: lp,
      series_slug: series || undefined,
      priority: Number.isFinite(priority) ? priority : 0,
      enabled,
      rules_json: rules,
    };
    const url = id ? ("/api/admin/glossaries/" + encodeURIComponent(id)) : "/api/admin/glossaries";
    const method = id ? "PUT" : "POST";
    const r = await fetch(url, {
      method,
      headers: { "content-type": "application/json", "X-CSRF-Token": csrf },
      body: JSON.stringify(payload),
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) {
      document.getElementById("glossaryFormMsg").textContent = data.detail || ("Save failed (" + r.status + ")");
      return;
    }
    document.getElementById("glossaryFormMsg").textContent = "Saved";
    clearGlossaryForm();
    await loadGlossaries();
  }

  async function deleteGlossary(id) {
    if (!confirm("Delete glossary " + id + "?")) return;
    const csrf = document.getElementById("csrf")?.value || "";
    const r = await fetch("/api/admin/glossaries/" + encodeURIComponent(id), { method: "DELETE", headers: { "X-CSRF-Token": csrf } });
    if (!r.ok) {
      window.showToast("Delete failed", "error");
      return;
    }
    window.showToast("Deleted", "success");
    await loadGlossaries();
  }

  loadGlossaries();
</script>
{% endblock %}
