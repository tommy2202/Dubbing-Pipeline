{% extends "_base.html" %}

{% block title %}Dashboard • anime_v2{% endblock %}

{% block content %}
<div class="flex items-start justify-between gap-4">
  <div>
    <h1 class="text-2xl font-semibold">Dashboard</h1>
    <p class="mt-1 text-sm text-slate-400">Recent jobs with live progress.</p>
  </div>
  {% if user and user.role and user.role.value != "viewer" %}
  <a href="/ui/upload" class="rounded-lg bg-indigo-600 hover:bg-indigo-500 px-4 py-3 text-sm font-medium">
    New Job
  </a>
  {% endif %}
</div>

<div class="mt-6 grid gap-4 lg:grid-cols-3">
  <div id="dashJobs" class="rounded-xl border border-slate-800 bg-slate-900/40 p-4 lg:col-span-2" x-data="{status:'', q:''}">
    <div class="flex flex-wrap items-end justify-between gap-3">
      <div class="text-sm text-slate-300">Jobs</div>
      <div class="flex flex-wrap items-center gap-2 text-sm">
        <div>
          <label class="block text-xs text-slate-500" for="jobStatus">Status</label>
          <select id="jobStatus" class="mt-1 rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-sm" x-model="status" @change="reloadJobs()">
            <option value="">All</option>
            <option value="QUEUED">QUEUED</option>
            <option value="PAUSED">PAUSED</option>
            <option value="RUNNING">RUNNING</option>
            <option value="DONE">DONE</option>
            <option value="FAILED">FAILED</option>
            <option value="CANCELED">CANCELED</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-slate-500" for="jobSearch">Search</label>
          <input id="jobSearch" class="mt-1 rounded-lg bg-slate-950 border border-slate-800 px-3 py-3 text-sm"
                 placeholder="job id or filename" x-model="q" aria-describedby="jobSearchHelp"
                 @keydown.enter.prevent="reloadJobs()" />
          <div id="jobSearchHelp" class="sr-only">Press Enter to apply filters.</div>
        </div>
        <button class="rounded-lg bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm"
                @click="reloadJobs()">Apply</button>
      </div>
    </div>

    {% if user and user.role and user.role.value != "viewer" %}
    <div class="mt-4 flex flex-wrap items-center gap-2 text-sm">
      <button class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm"
              @click="bulkAction('pause')">Pause</button>
      <button class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm"
              @click="bulkAction('resume')">Resume</button>
      <button class="rounded bg-red-900/40 hover:bg-red-900/60 px-4 py-3 text-sm text-red-100"
              @click="bulkAction('cancel')">Cancel</button>
    </div>
    {% else %}
    <div class="mt-4 text-sm text-slate-500">Viewer role: read-only.</div>
    {% endif %}

    <div
      id="job-table"
      class="mt-4"
      hx-get="/ui/partials/jobs_table?limit=25"
      hx-trigger="load"
      hx-swap="innerHTML"
    ></div>
  </div>

  <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
    <div class="flex items-center justify-between gap-2">
      <div class="text-sm text-slate-300">Audit (you)</div>
      <button class="rounded bg-slate-800 hover:bg-slate-700 px-3 py-2 text-sm" onclick="loadAudit()">Refresh</button>
    </div>
    <div class="mt-2 text-xs text-slate-500">Last 50 security-relevant events for your user.</div>
    <div id="auditPanel" class="mt-3 space-y-2 text-sm"></div>
  </div>
</div>

<script>
  function selectedJobIds() {
    return Array.from(document.querySelectorAll("input[data-job-select]:checked")).map((cb) => cb.value);
  }

  function reloadJobs() {
    const root = document.getElementById("dashJobs");
    const status = root && root.__x ? root.__x.$data.status : "";
    const q = root && root.__x ? root.__x.$data.q : "";
    const url = "/ui/partials/jobs_table?limit=25"
      + (status ? ("&status=" + encodeURIComponent(status)) : "")
      + (q ? ("&q=" + encodeURIComponent(q)) : "");
    if (window.htmx) window.htmx.ajax("GET", url, "#job-table");
  }

  async function jobAction(action, jobId) {
    const csrf = document.getElementById("csrf")?.value || "";
    const url = "/api/jobs/" + encodeURIComponent(jobId) + "/" + action;
    const r = await fetch(url, { method: "POST", credentials: "include", headers: { "X-CSRF-Token": csrf } });
    if (!r.ok) {
      try {
        const data = await r.json();
        window.showToast((data && data.detail) ? data.detail : ("Action failed (" + r.status + ")"), "error");
      } catch (e) {
        window.showToast("Action failed (" + r.status + ")", "error");
      }
      return;
    }
    window.showToast(action + " OK", "success");
  }

  async function bulkAction(action) {
    const ids = selectedJobIds();
    if (!ids.length) return;
    for (const id of ids) {
      await jobAction(action, id);
    }
  }

  // Live updates via SSE
  (function () {
    try {
      const es = new EventSource("/api/jobs/events");
      es.addEventListener("job", function (evt) {
        try {
          const data = JSON.parse(evt.data || "{}");
          const id = data.id;
          if (!id) return;
          const row = document.getElementById("job-row-" + id);
          if (!row) {
            // new job: reload table
            reloadJobs();
            return;
          }
          const st = row.querySelector("[data-job-state]");
          const pr = row.querySelector("[data-job-progress]");
          if (st) st.textContent = data.state || "";
          if (pr) pr.textContent = Math.round((Number(data.progress || 0) * 100)) + "%";
        } catch (e) {}
      });
    } catch (e) {}
  })();

  async function loadAudit() {
    const root = document.getElementById("auditPanel");
    if (!root) return;
    root.innerHTML = '<div class="text-sm text-slate-500">Loading…</div>';
    try {
      const r = await fetch("/api/audit/recent?limit=50", { credentials: "include" });
      if (!r.ok) {
        root.innerHTML = '<div class="text-sm text-slate-500">Unavailable.</div>';
        return;
      }
      const d = await r.json().catch(() => ({}));
      const items = Array.isArray(d.items) ? d.items : [];
      if (!items.length) {
        root.innerHTML = '<div class="text-sm text-slate-500">No audit events yet.</div>';
        return;
      }
      root.innerHTML = items.slice().reverse().map((it) => {
        const ts = it.ts ? String(it.ts) : "";
        const ev = it.event ? String(it.event) : "";
        const meta = (it.meta && typeof it.meta === "object") ? JSON.stringify(it.meta) : "";
        return `
          <div class="rounded-lg border border-slate-800 bg-slate-950/20 p-3">
            <div class="text-xs text-slate-500">${ts}</div>
            <div class="text-sm text-slate-200">${ev}</div>
            ${meta ? `<div class="mt-1 text-xs text-slate-500 break-words">${meta}</div>` : ``}
          </div>
        `;
      }).join("");
    } catch (e) {
      root.innerHTML = '<div class="text-sm text-slate-500">Unavailable.</div>';
    }
  }
  loadAudit();
</script>
{% endblock %}

