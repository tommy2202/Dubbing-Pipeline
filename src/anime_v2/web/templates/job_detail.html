{% extends "_base.html" %}

{% block title %}Job {{ job_id }} • anime_v2{% endblock %}

{% block content %}
{% if created %}
<div class="mb-4 rounded-lg border border-emerald-900/50 bg-emerald-900/20 px-4 py-3 text-sm text-emerald-100">
  Job created.
</div>
{% endif %}

<div
  x-data="jobDetail('{{ job_id }}')"
  x-init="init()"
>
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold">Job</h1>
      <p class="mt-1 text-sm text-slate-400 break-all">{{ job_id }}</p>
      <p class="mt-2 text-sm text-slate-300" x-text="job ? (job.state + ': ' + (job.message || '')) : 'Loading…'"></p>
      <p class="mt-1 text-xs text-slate-500" x-text="job ? ('Progress: ' + Math.round((job.progress||0)*100) + '%') : ''"></p>
    </div>
    <div class="flex items-center gap-2">
      <button class="rounded bg-red-900/40 hover:bg-red-900/60 px-3 py-2 text-sm text-red-100"
              @click="doAction('cancel')" :disabled="!job || !['QUEUED','RUNNING','PAUSED'].includes(job.state) {% if user and user.role and user.role.value == 'viewer' %} || true {% endif %}">
        Cancel
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="mt-6 border-b border-slate-800">
    <nav class="flex flex-wrap gap-2 text-sm" aria-label="Job sections">
      <template x-for="t in tabs" :key="t.key">
        <button
          type="button"
          class="rounded-t-lg px-4 py-3"
          :class="activeTab===t.key ? 'bg-slate-900/60 text-white' : 'text-slate-400 hover:text-slate-200'"
          @click="setActive(t.key)"
        >
          <span x-text="t.label"></span>
        </button>
      </template>
    </nav>
  </div>

  <!-- Overview -->
  <div class="mt-4" x-show="activeTab==='overview'">
    <div class="grid gap-4 lg:grid-cols-2">
      <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
        <div class="text-sm text-slate-300">Summary</div>
        <div class="mt-3 text-sm text-slate-200 space-y-1">
          <div><span class="text-slate-500">State:</span> <span x-text="job?.state || ''"></span></div>
          <div><span class="text-slate-500">Mode:</span> <span x-text="job?.mode || ''"></span></div>
          <div x-show="job && job.runtime && job.runtime.effective_settings">
            <span class="text-slate-500">Effective:</span>
            <span class="break-all" x-text="job.runtime.effective_settings.effective_mode || ''"></span>
          </div>
          <div><span class="text-slate-500">Device:</span> <span x-text="job?.device || ''"></span></div>
          <div><span class="text-slate-500">Lang:</span> <span x-text="(job?.src_lang||'') + ' → ' + (job?.tgt_lang||'')"></span></div>
          <div><span class="text-slate-500">PG:</span> <span x-text="(job && job.runtime && job.runtime.pg) ? job.runtime.pg : 'off'"></span></div>
          <div><span class="text-slate-500">Created:</span> <span x-text="job?.created_at || ''"></span></div>
          <div><span class="text-slate-500">Updated:</span> <span x-text="job?.updated_at || ''"></span></div>
        </div>
        <div class="mt-3" x-show="job && job.runtime && job.runtime.effective_settings" x-cloak>
          <div class="text-sm text-slate-300">Effective settings (summary)</div>
          <pre class="mt-2 whitespace-pre-wrap text-xs text-slate-300"
               x-text="JSON.stringify(job.runtime.effective_settings, null, 2)"></pre>
        </div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
        <div class="text-sm text-slate-300">Stage breakdown</div>
        <template x-if="!job || !job.checkpoint || !job.checkpoint.stages">
          <div class="mt-3 text-sm text-slate-500">No checkpoint yet.</div>
        </template>
        <template x-if="job && job.checkpoint && job.checkpoint.stages">
          <div class="mt-3 overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-xs text-slate-500">
                <tr>
                  <th class="text-left py-1 pr-3">Stage</th>
                  <th class="text-left py-1 pr-3">Done</th>
                  <th class="text-left py-1 pr-3">Done at</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(v, k) in job.checkpoint.stages" :key="k">
                  <tr class="border-t border-slate-900">
                    <td class="py-1 pr-3 text-slate-200" x-text="k"></td>
                    <td class="py-1 pr-3 text-slate-200" x-text="v && v.done ? 'yes' : 'no'"></td>
                    <td class="py-1 pr-3 text-slate-500" x-text="v && v.done_at ? new Date(v.done_at * 1000).toISOString() : ''"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Quality -->
  <div class="mt-4" x-show="activeTab==='quality'" x-cloak>
    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <div class="text-sm text-slate-300">Quality</div>
      <template x-if="!qaSummary">
        <div class="mt-3 text-sm text-slate-500">
          No QA report yet. Enable it on submit (QA checkbox) or run:
          <code class="text-slate-300">anime-v2 qa run &lt;job&gt;</code>
        </div>
      </template>
      <template x-if="qaSummary">
        <div class="mt-3 text-sm text-slate-200 space-y-2">
          <div>
            <span class="text-slate-500">Score:</span>
            <span class="font-semibold" x-text="(qaSummary.score || 0).toFixed(1) + '/100'"></span>
          </div>
          <div class="text-xs text-slate-500">
            <span x-text="'fail=' + (qaSummary.counts?.fail || 0) + ' warn=' + (qaSummary.counts?.warn || 0) + ' info=' + (qaSummary.counts?.info || 0)"></span>
          </div>
          <div class="mt-3">
            <div class="text-sm text-slate-300">Top issues</div>
            <template x-if="Array.isArray(qaSummary.top_issues) && qaSummary.top_issues.length">
              <div class="mt-2 space-y-2">
                <template x-for="it in qaSummary.top_issues" :key="(it.segment_id||'') + ':' + (it.check_id||'')">
                  <div class="rounded border border-slate-800 bg-slate-950/30 p-3 text-sm">
                    <div class="text-slate-200">
                      <span class="text-slate-500">seg</span>
                      <span x-text="it.segment_id"></span>
                      <span class="text-slate-500">·</span>
                      <span class="text-slate-300" x-text="it.severity"></span>
                      <span class="text-slate-500">·</span>
                      <code class="text-slate-300" x-text="it.check_id"></code>
                    </div>
                    <div class="mt-1 text-slate-200" x-text="it.message || ''"></div>
                    <div class="mt-1 text-xs text-slate-500" x-text="'Suggested: ' + (it.suggested_action || '')"></div>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="(!qaSummary.top_issues || !qaSummary.top_issues.length) && qaTopMd">
              <pre class="mt-2 whitespace-pre-wrap text-xs text-slate-300" x-text="qaTopMd"></pre>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Transcript -->
  <div class="mt-4" x-show="activeTab==='transcript'" x-cloak>
    {% include "partials/transcript_editor.html" %}
  </div>

  <!-- Voice Map -->
  <div class="mt-4" x-show="activeTab==='voice'" x-cloak>
    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-slate-300">Voice Map</div>
        <button class="rounded bg-indigo-600 hover:bg-indigo-500 px-3 py-2 text-sm font-medium {% if user and user.role and user.role.value == 'viewer' %}opacity-50 cursor-not-allowed{% endif %}"
                @click="saveVoiceMap()" {% if user and user.role and user.role.value == 'viewer' %}disabled{% endif %}>
          Save Mapping
        </button>
      </div>
      <div class="mt-3 text-xs text-slate-500">Persists to the job record; used for future synth (best-effort).</div>

      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-xs text-slate-500">
            <tr>
              <th class="text-left py-2 pr-3">character_id</th>
              <th class="text-left py-2 pr-3">label</th>
              <th class="text-left py-2 pr-3">strategy</th>
              <th class="text-left py-2 pr-3">tts_speaker</th>
              <th class="text-left py-2 pr-3">tts_speaker_wav</th>
              <th class="text-left py-2 pr-3">language</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(row, idx) in voiceItems" :key="idx">
              <tr class="border-t border-slate-900">
                <td class="py-2 pr-3">
                  <input class="w-40 rounded bg-slate-950 border border-slate-800 px-2 py-1 text-xs"
                         x-model="row.character_id" placeholder="SPEAKER_01" />
                </td>
                <td class="py-2 pr-3">
                  <input class="w-40 rounded bg-slate-950 border border-slate-800 px-2 py-1 text-xs"
                         x-model="row.label" placeholder="Alice" />
                </td>
                <td class="py-2 pr-3">
                  <select class="rounded bg-slate-950 border border-slate-800 px-2 py-1 text-xs"
                          x-model="row.speaker_strategy">
                    <option value="zero-shot">zero-shot</option>
                    <option value="preset">preset</option>
                  </select>
                </td>
                <td class="py-2 pr-3">
                  <input class="w-40 rounded bg-slate-950 border border-slate-800 px-2 py-1 text-xs"
                         x-model="row.tts_speaker" :disabled="row.speaker_strategy!=='preset'" placeholder="default" />
                </td>
                <td class="py-2 pr-3">
                  <div class="text-xs text-slate-400" x-text="row.tts_speaker_wav || ''"></div>
                </td>
                <td class="py-2 pr-3">
                  <select class="rounded bg-slate-950 border border-slate-800 px-2 py-1 text-xs"
                          x-model="row.language">
                    <option value="en">en</option>
                    <option value="ja">ja</option>
                    <option value="auto">auto</option>
                  </select>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <button class="mt-4 rounded bg-slate-800 hover:bg-slate-700 px-3 py-2 text-sm"
              @click="voiceItems.push({character_id:'', label:'', speaker_strategy:'preset', tts_speaker:'default', tts_speaker_wav:'', language:'en'})">
        Add row
      </button>

      <div class="mt-3 text-sm text-emerald-200" x-show="voiceSaved" x-cloak>Saved.</div>
      <div class="mt-3 text-sm text-red-200" x-show="voiceError" x-cloak x-text="voiceError"></div>
    </div>
  </div>

  <!-- Logs -->
  <div class="mt-4" x-show="activeTab==='logs'" x-cloak>
    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <div class="text-sm text-slate-300">Logs (live)</div>
      <div class="mt-3 h-80 overflow-auto rounded-lg bg-black/40 border border-slate-800 p-3 text-xs font-mono text-slate-200"
           hx-ext="sse"
           sse-connect="/api/jobs/{{ job_id }}/logs/stream"
           sse-swap="message"
           hx-swap="beforeend">
      </div>
    </div>
  </div>

  <!-- Artifacts -->
  <div class="mt-4" x-show="activeTab==='artifacts'" x-cloak>
    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <div class="text-sm text-slate-300">Artifacts</div>
      <div class="mt-3 grid gap-4 lg:grid-cols-3">
        <div class="lg:col-span-2">
          <template x-if="files && files.hls_manifest">
            <div>
              <div class="text-sm text-slate-300 mb-2">Player (HLS)</div>
              <link href="https://vjs.zencdn.net/8.17.4/video-js.css" rel="stylesheet" />
              <video id="player" class="video-js vjs-default-skin w-full rounded-lg border border-slate-800" controls playsinline preload="auto"
                     aria-label="Video player"></video>
              <script src="https://vjs.zencdn.net/8.17.4/video.min.js"></script>
              <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15"></script>
            </div>
          </template>
          <template x-if="files && !files.hls_manifest && files.mp4">
            <div>
              <div class="text-sm text-slate-300 mb-2">Player (MP4)</div>
              <link href="https://vjs.zencdn.net/8.17.4/video-js.css" rel="stylesheet" />
              <video id="player" class="video-js vjs-default-skin w-full rounded-lg border border-slate-800" controls playsinline preload="auto"
                     aria-label="Video player"></video>
              <script src="https://vjs.zencdn.net/8.17.4/video.min.js"></script>
            </div>
          </template>
          <template x-if="files && !files.hls_manifest && !files.mp4">
            <div class="text-sm text-slate-400">
              No HLS/MP4 available. Use download links below.
            </div>
          </template>

          <div class="mt-4 text-sm text-slate-200 space-y-2">
            <template x-if="files && files.hls_manifest">
              <div><span class="text-slate-500">HLS:</span> <a class="underline" :href="files.hls_manifest.url" target="_blank" rel="noreferrer">manifest</a></div>
            </template>
            <template x-if="files && files.mp4">
              <div><span class="text-slate-500">MP4:</span> <a class="underline" :href="files.mp4.url" target="_blank" rel="noreferrer" download>download</a></div>
            </template>
            <template x-if="files && files.mkv">
              <div><span class="text-slate-500">MKV:</span> <a class="underline" :href="files.mkv.url" target="_blank" rel="noreferrer" download>download</a></div>
            </template>
            <div><span class="text-slate-500">SRT:</span> <span class="break-all" x-text="job?.output_srt || ''"></span></div>
          </div>
        </div>

        <div class="rounded-xl border border-slate-800 bg-slate-950/20 p-4">
          <div class="text-sm text-slate-300">Open on mobile</div>
          <div class="mt-2 text-xs text-slate-500">Scan to open this job page.</div>
          <img class="mt-3 w-48 h-48 rounded bg-white p-2"
               :src="('/api/jobs/' + encodeURIComponent(jobId) + '/qrcode')"
               alt="QR code to open job" />
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sticky mobile player controls -->
<div class="sm:hidden fixed bottom-0 left-0 right-0 z-40 border-t border-slate-800 bg-slate-950/95 px-3 py-2"
     x-show="activeTab==='artifacts' && hasPlayer" x-cloak
     role="region" aria-label="Playback controls">
  <div class="flex items-center justify-between gap-2">
    <button type="button" class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm"
            @click="togglePlay()" aria-label="Play or pause">
      <span x-text="playing ? 'Pause' : 'Play'"></span>
    </button>
    <button type="button" class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm"
            @click="toggleMute()" aria-label="Mute or unmute">
      <span x-text="muted ? 'Unmute' : 'Mute'"></span>
    </button>
    <label class="sr-only" for="rateSel">Playback rate</label>
    <select id="rateSel" class="rounded bg-slate-950 border border-slate-800 px-2 py-3 text-sm"
            @change="setRate($event.target.value)" aria-label="Playback rate">
      <option value="0.75">0.75×</option>
      <option value="1" selected>1×</option>
      <option value="1.25">1.25×</option>
      <option value="1.5">1.5×</option>
    </select>
  </div>
</div>

<script>
  function jobDetail(jobId) {
    return {
      jobId,
      job: null,
      activeTab: "overview",
      tabs: [
        { key: "overview", label: "Overview" },
        { key: "quality", label: "Quality" },
        { key: "transcript", label: "Transcript" },
        { key: "voice", label: "Voice Map" },
        { key: "logs", label: "Logs" },
        { key: "artifacts", label: "Artifacts" },
      ],
      setActive(tab) {
        this.activeTab = tab;
        if (tab === "quality") {
          if (!this.qaLoaded) this.loadQA();
        }
        if (tab === "artifacts") {
          // ensure files loaded and player initialized
          if (!this.files) this.loadFiles();
          else this.initPlayer();
        }
      },
      voiceItems: [],
      voiceSaved: false,
      voiceError: "",
      files: null,
      qaLoaded: false,
      qaSummary: null,
      qaTopMd: "",
      hasPlayer: false,
      playing: false,
      muted: false,
      _vjs: null,
      _playerInit: false,
      async init() {
        await this.refresh();
        await this.loadVoiceMap();
        await this.loadFiles();
        await this.loadQA();
        try {
          const m = document.getElementById("main");
          if (m) m.focus();
        } catch (e) {}
        // poll job state lightly (UI only)
        setInterval(() => { this.refresh(); }, 1500);
      },
      async refresh() {
        try {
          const r = await fetch("/api/jobs/" + encodeURIComponent(this.jobId), { credentials: "include" });
          if (!r.ok) return;
          this.job = await r.json();
        } catch (e) {}
      },
      async loadFiles() {
        try {
          const r = await fetch("/api/jobs/" + encodeURIComponent(this.jobId) + "/files", { credentials: "include" });
          if (!r.ok) return;
          this.files = await r.json();
          this.hasPlayer = !!(this.files && ((this.files.hls_manifest && this.files.hls_manifest.url) || (this.files.mp4 && this.files.mp4.url)));
          // init player if artifacts tab active
          if (this.activeTab === "artifacts") this.initPlayer();
        } catch (e) {}
      },
      async loadQA() {
        this.qaLoaded = true;
        this.qaSummary = null;
        this.qaTopMd = "";
        try {
          if (!this.files) {
            await this.loadFiles();
          }
          const sum = this.files && this.files.qa_summary ? this.files.qa_summary.url : null;
          if (sum) {
            const r = await fetch(sum, { credentials: "include" });
            if (r.ok) this.qaSummary = await r.json();
          }
          const md = this.files && this.files.qa_top_issues ? this.files.qa_top_issues.url : null;
          if (md) {
            const r2 = await fetch(md, { credentials: "include" });
            if (r2.ok) this.qaTopMd = await r2.text();
          }
        } catch (e) {}
      },
      initPlayer() {
        if (this._playerInit) return;
        if (!this.files) return;
        const playerEl = document.getElementById("player");
        if (!playerEl) return;
        try {
          const vjs = window.videojs ? window.videojs(playerEl, { controls: true, playbackRates: [0.5, 1, 1.25, 1.5, 2] }) : null;
          this._vjs = vjs || null;
          if (this.files.hls_manifest && this.files.hls_manifest.url) {
            const src = this.files.hls_manifest.url;
            // Prefer native/VHS; fall back to hls.js when needed.
            if (vjs) {
              vjs.src({ src: src, type: "application/x-mpegURL" });
            } else if (window.Hls && window.Hls.isSupported()) {
              const hls = new window.Hls();
              hls.loadSource(src);
              hls.attachMedia(playerEl);
            } else {
              playerEl.src = src;
            }
          } else if (this.files.mp4 && this.files.mp4.url) {
            const src = this.files.mp4.url;
            if (vjs) vjs.src({ src: src, type: "video/mp4" });
            else playerEl.src = src;
          }
          if (vjs) {
            vjs.on("play", () => { this.playing = true; });
            vjs.on("pause", () => { this.playing = false; });
            vjs.on("volumechange", () => { this.muted = !!vjs.muted(); });
          } else {
            playerEl.addEventListener("play", () => { this.playing = true; });
            playerEl.addEventListener("pause", () => { this.playing = false; });
            playerEl.addEventListener("volumechange", () => { this.muted = !!playerEl.muted; });
          }
          this._playerInit = true;
        } catch (e) {}
      },
      togglePlay() {
        try {
          if (this._vjs) {
            if (this._vjs.paused()) this._vjs.play();
            else this._vjs.pause();
            return;
          }
          const el = document.getElementById("player");
          if (!el) return;
          if (el.paused) el.play();
          else el.pause();
        } catch (e) {}
      },
      toggleMute() {
        try {
          if (this._vjs) {
            this._vjs.muted(!this._vjs.muted());
            this.muted = !!this._vjs.muted();
            return;
          }
          const el = document.getElementById("player");
          if (!el) return;
          el.muted = !el.muted;
          this.muted = !!el.muted;
        } catch (e) {}
      },
      setRate(v) {
        try {
          const r = Number(v || 1);
          if (!Number.isFinite(r)) return;
          if (this._vjs) {
            this._vjs.playbackRate(r);
            return;
          }
          const el = document.getElementById("player");
          if (!el) return;
          el.playbackRate = r;
        } catch (e) {}
      },
      async loadVoiceMap() {
        try {
          const r = await fetch("/api/jobs/" + encodeURIComponent(this.jobId) + "/characters", { credentials: "include" });
          if (!r.ok) return;
          const data = await r.json();
          this.voiceItems = Array.isArray(data.items) ? data.items : [];
          if (!this.voiceItems.length) {
            this.voiceItems = [{character_id:"", label:"", speaker_strategy:"preset", tts_speaker:"default", tts_speaker_wav:"", language:"en"}];
          }
        } catch (e) {}
      },
      async saveVoiceMap() {
        this.voiceSaved = false;
        this.voiceError = "";
        try {
          const csrf = document.getElementById("csrf")?.value || "";
          const r = await fetch("/api/jobs/" + encodeURIComponent(this.jobId) + "/characters", {
            method: "PUT",
            credentials: "include",
            headers: { "content-type": "application/json", "X-CSRF-Token": csrf },
            body: JSON.stringify({ items: this.voiceItems }),
          });
          const data = await r.json().catch(() => ({}));
          if (!r.ok) {
            this.voiceError = data.detail || ("Save failed (" + r.status + ")");
            try { window.showToast(this.voiceError, "error"); } catch (e) {}
            return;
          }
          this.voiceItems = Array.isArray(data.items) ? data.items : this.voiceItems;
          this.voiceSaved = true;
          try { window.showToast("Saved speaker mapping", "success"); } catch (e) {}
          setTimeout(() => { this.voiceSaved = false; }, 1500);
        } catch (e) {
          this.voiceError = "Save failed";
          try { window.showToast(this.voiceError, "error"); } catch (e) {}
        }
      },
      async doAction(action) {
        try {
          const csrf = document.getElementById("csrf")?.value || "";
          await fetch("/api/jobs/" + encodeURIComponent(this.jobId) + "/" + action, {
            method: "POST",
            credentials: "include",
            headers: { "X-CSRF-Token": csrf },
          });
          await this.refresh();
        } catch (e) {}
      },
    };
  }
</script>
{% endblock %}

