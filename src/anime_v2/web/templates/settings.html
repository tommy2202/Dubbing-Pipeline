{% extends "_base.html" %}

{% block title %}Settings â€¢ anime_v2{% endblock %}

{% block content %}
<div class="flex items-start justify-between gap-4">
  <div>
    <h1 class="text-2xl font-semibold">Settings</h1>
    <p class="mt-1 text-sm text-slate-400">Per-user defaults and session management.</p>
  </div>
</div>

<div class="mt-6 grid gap-4 lg:grid-cols-2" x-data="settingsPage()" x-init="init()">
  <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
    <h2 class="text-sm text-slate-300">Defaults (new uploads)</h2>
    <p class="mt-1 text-xs text-slate-500">These pre-fill the Upload Wizard for your account.</p>
    {% if not can_edit_settings %}
      <div class="mt-2 text-sm text-slate-500">Viewer role: read-only.</div>
    {% endif %}

    <div class="mt-4 grid gap-4 sm:grid-cols-2 text-sm">
      <div>
        <label class="block text-sm text-slate-300" for="defMode">Mode</label>
        <select id="defMode" class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3"
                x-model="form.defaults.mode">
          <option value="high">high</option>
          <option value="medium">medium</option>
          <option value="low">low</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-slate-300" for="defDevice">Device</label>
        <select id="defDevice" class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3"
                x-model="form.defaults.device">
          <option value="auto">auto</option>
          <option value="cpu">cpu</option>
          <option value="cuda">cuda</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-slate-300" for="defSrc">Source lang</label>
        <input id="defSrc" class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3"
               placeholder="ja" x-model="form.defaults.src_lang" />
      </div>
      <div>
        <label class="block text-sm text-slate-300" for="defTgt">Target lang</label>
        <input id="defTgt" class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3"
               placeholder="en" x-model="form.defaults.tgt_lang" />
      </div>
      <div>
        <label class="block text-sm text-slate-300" for="defTtsLang">TTS lang</label>
        <input id="defTtsLang" class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3"
               placeholder="en" x-model="form.defaults.tts_lang" />
      </div>
      <div>
        <label class="block text-sm text-slate-300" for="defTtsSpeaker">TTS speaker</label>
        <input id="defTtsSpeaker" class="mt-1 w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-3"
               placeholder="default" x-model="form.defaults.tts_speaker" />
      </div>
    </div>

    <div class="mt-4 flex flex-wrap items-center gap-2">
      <button class="rounded bg-emerald-600 hover:bg-emerald-500 px-4 py-3 text-sm font-medium {% if not can_edit_settings %}opacity-50 cursor-not-allowed{% endif %}"
              @click="save()" {% if not can_edit_settings %}disabled{% endif %}>
        Save
      </button>
      <div class="text-sm text-red-200" role="alert" aria-live="polite" x-show="error" x-cloak x-text="error"></div>
      <div class="text-sm text-emerald-200" aria-live="polite" x-show="toast" x-cloak x-text="toast"></div>
    </div>
  </div>

  <div class="space-y-4">
    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <h2 class="text-sm text-slate-300">Sessions</h2>
      <p class="mt-1 text-xs text-slate-500">Manage your active devices/sessions (refresh-token chains).</p>

      <div class="mt-3 space-y-2 text-sm" x-show="sessions && sessions.length">
        <template x-for="s in sessions" :key="s.device_id">
          <div class="rounded-lg border border-slate-800 bg-slate-950/20 p-3">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="text-slate-200">
                  <span class="font-medium" x-text="s.device_name || 'device'"></span>
                  <span class="text-xs text-slate-500 ml-2" x-text="s.device_id"></span>
                </div>
                <div class="mt-1 text-xs text-slate-500 break-words" x-text="s.user_agent"></div>
                <div class="mt-1 text-xs text-slate-500">
                  <span>Created:</span> <span x-text="new Date((s.created_at||0)*1000).toISOString()"></span>
                  <template x-if="s.last_used_at">
                    <span class="ml-2"><span>Last used:</span> <span x-text="new Date((s.last_used_at||0)*1000).toISOString()"></span></span>
                  </template>
                </div>
              </div>
              <button class="rounded bg-red-900/40 hover:bg-red-900/60 px-3 py-2 text-sm text-red-100"
                      @click="revokeSession(s.device_id)">
                Revoke
              </button>
            </div>
          </div>
        </template>
      </div>
      <div class="mt-3 text-sm text-slate-500" x-show="sessions && !sessions.length">No active sessions.</div>

      <div class="mt-3 flex flex-wrap items-center gap-2">
        <button class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm" @click="loadSessions()">Refresh</button>
        <button class="rounded bg-red-900/40 hover:bg-red-900/60 px-4 py-3 text-sm text-red-100"
                @click="revokeAllSessions()">
          Revoke all
        </button>
      </div>
    </div>

    {% if user and user.role and user.role.value == "admin" %}
    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <h2 class="text-sm text-slate-300">QR login (admin)</h2>
      <p class="mt-1 text-xs text-slate-500">Generates a single-use code for quick phone login. Requires ENABLE_QR_LOGIN=1.</p>

      <div class="mt-3 flex flex-wrap items-center gap-2">
        <button class="rounded bg-indigo-600 hover:bg-indigo-500 px-4 py-3 text-sm font-medium"
                @click="genQr()">
          Generate QR
        </button>
        <a class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm" x-show="qrRedeemUrl" x-cloak
           :href="qrRedeemUrl" target="_blank" rel="noopener">
          Open link
        </a>
      </div>
      <div class="mt-3 text-xs text-slate-500" x-show="qrExpiresAt" x-cloak>
        Expires at: <span x-text="qrExpiresAt"></span>
      </div>
      <div class="mt-3 rounded-lg border border-slate-800 bg-slate-950/20 p-3 text-xs text-slate-500 break-words" x-show="qrRedeemUrl" x-cloak>
        <div class="text-slate-300 text-sm">Redeem URL</div>
        <div class="mt-1" x-text="qrRedeemUrl"></div>
      </div>
    </div>
    {% endif %}

    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <h2 class="text-sm text-slate-300">Notifications</h2>
      <p class="mt-1 text-xs text-slate-500">
        Job-finish notifications are supported via optional private self-hosted <code>ntfy</code> (server-level config).
        See <code>docs/notifications.md</code>.
      </p>
      <div class="mt-3 text-sm text-slate-500">
        <span class="text-slate-400">NTFY_ENABLED:</span> {{ 1 if (system.notifications.ntfy_enabled if system and system.notifications else false) else 0 }}
      </div>
    </div>

    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <h2 class="text-sm text-slate-300">Runtime limits (read-only)</h2>
      <div class="mt-3 text-sm text-slate-200 space-y-1">
        <div><span class="text-slate-500">MAX_CONCURRENCY_GLOBAL:</span> {{ system.limits.max_concurrency_global }}</div>
        <div><span class="text-slate-500">MAX_CONCURRENCY_TRANSCRIBE:</span> {{ system.limits.max_concurrency_transcribe }}</div>
        <div><span class="text-slate-500">MAX_CONCURRENCY_TTS:</span> {{ system.limits.max_concurrency_tts }}</div>
        <div><span class="text-slate-500">BACKPRESSURE_Q_MAX:</span> {{ system.limits.backpressure_q_max }}</div>
      </div>

      <h3 class="mt-4 text-sm text-slate-300">Latency budgets (read-only)</h3>
      <div class="mt-2 text-sm text-slate-200 space-y-1">
        <div><span class="text-slate-500">BUDGET_TRANSCRIBE_SEC:</span> {{ system.budgets.budget_transcribe_sec }}</div>
        <div><span class="text-slate-500">BUDGET_TTS_SEC:</span> {{ system.budgets.budget_tts_sec }}</div>
        <div><span class="text-slate-500">BUDGET_MUX_SEC:</span> {{ system.budgets.budget_mux_sec }}</div>
      </div>
    </div>
  </div>
</div>

<script>
  function settingsPage() {
    return {
      error: "",
      toast: "",
      sessions: [],
      qrRedeemUrl: "",
      qrExpiresAt: "",
      form: {
        defaults: {
          mode: "{{ ((cfg.defaults.mode if cfg and cfg.defaults and cfg.defaults.mode else 'medium') | e) }}",
          device: "{{ ((cfg.defaults.device if cfg and cfg.defaults and cfg.defaults.device else 'auto') | e) }}",
          src_lang: "{{ ((cfg.defaults.src_lang if cfg and cfg.defaults and cfg.defaults.src_lang else 'ja') | e) }}",
          tgt_lang: "{{ ((cfg.defaults.tgt_lang if cfg and cfg.defaults and cfg.defaults.tgt_lang else 'en') | e) }}",
          tts_lang: "{{ ((cfg.defaults.tts_lang if cfg and cfg.defaults and cfg.defaults.tts_lang else 'en') | e) }}",
          tts_speaker: "{{ ((cfg.defaults.tts_speaker if cfg and cfg.defaults and cfg.defaults.tts_speaker else 'default') | e) }}",
        },
      },
      init() {},
      async loadSessions() {
        this.error = "";
        const r = await fetch("/api/auth/sessions", { credentials: "include" });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) {
          this.error = d.detail || ("Failed to load sessions (" + r.status + ")");
          return;
        }
        this.sessions = Array.isArray(d.items) ? d.items : [];
      },
      async revokeSession(deviceId) {
        const csrf = document.getElementById("csrf")?.value || "";
        const r = await fetch("/api/auth/sessions/" + encodeURIComponent(deviceId) + "/revoke", {
          method: "POST",
          credentials: "include",
          headers: {"X-CSRF-Token": csrf},
        });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) {
          this.error = d.detail || ("Revoke failed (" + r.status + ")");
          return;
        }
        await this.loadSessions();
        try { window.showToast("Session revoked", "success"); } catch (e) {}
      },
      async revokeAllSessions() {
        const csrf = document.getElementById("csrf")?.value || "";
        const r = await fetch("/api/auth/sessions/revoke_all", {
          method: "POST",
          credentials: "include",
          headers: {"X-CSRF-Token": csrf},
        });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) {
          this.error = d.detail || ("Revoke all failed (" + r.status + ")");
          return;
        }
        await this.loadSessions();
        try { window.showToast("All sessions revoked", "success"); } catch (e) {}
      },
      async genQr() {
        this.error = "";
        const csrf = document.getElementById("csrf")?.value || "";
        const r = await fetch("/api/auth/qr/init", {
          method: "POST",
          credentials: "include",
          headers: {"content-type":"application/json", "X-CSRF-Token": csrf},
          body: JSON.stringify({}),
        });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) {
          this.error = d.detail || ("QR init failed (" + r.status + ")");
          return;
        }
        this.qrRedeemUrl = d.redeem_url || "";
        this.qrExpiresAt = d.expires_at ? (new Date(Number(d.expires_at) * 1000).toISOString()) : "";
        try { window.showToast("QR code created", "success"); } catch (e) {}
      },
      async save() {
        this.error = "";
        this.toast = "";
        const csrf = document.getElementById("csrf")?.value || "";
        const r = await fetch("/api/settings", {
          method: "PUT",
          credentials: "include",
          headers: { "content-type": "application/json", "X-CSRF-Token": csrf },
          body: JSON.stringify(this.form),
        });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) {
          this.error = d.detail || ("Save failed (" + r.status + ")");
          try { window.showToast(this.error, "error"); } catch (e) {}
          return;
        }
        this.toast = "Saved.";
        try { window.showToast("Settings saved", "success"); } catch (e) {}
        setTimeout(() => { this.toast = ""; }, 1200);
      },
    };
  }
</script>
{% endblock %}

