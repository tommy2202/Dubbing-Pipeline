{% extends "_base.html" %}

{% block title %}Models • anime_v2{% endblock %}

{% block content %}
<div x-data="modelsPage()" x-init="init()">
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold">Models</h1>
      <p class="mt-1 text-sm text-slate-400">Cache status and disk usage (offline-friendly).</p>
    </div>
    <button class="rounded bg-slate-800 hover:bg-slate-700 px-4 py-3 text-sm" @click="load()">Refresh</button>
  </div>

  <div class="mt-6 grid gap-4 lg:grid-cols-2">
    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <div class="text-sm text-slate-300">Disk</div>
      <template x-if="!data">
        <div class="mt-3 text-sm text-slate-500">Loading…</div>
      </template>
      <template x-if="data">
        <div class="mt-3 text-sm text-slate-200 space-y-1">
          <div><span class="text-slate-500">Output:</span> <span class="break-all" x-text="data.paths?.output_dir || ''"></span></div>
          <div><span class="text-slate-500">HF cache:</span> <span class="break-all" x-text="data.paths?.hf_home || ''"></span></div>
          <div><span class="text-slate-500">TTS cache:</span> <span class="break-all" x-text="data.paths?.tts_home || ''"></span></div>
          <div class="mt-2 text-xs text-slate-500" x-text="data.disk?.summary || ''"></div>
          <div class="mt-2 text-sm text-red-200" x-show="data.disk?.low_space" x-cloak>
            Low disk space. Consider cleaning old jobs or reducing caches.
          </div>
        </div>
      </template>
    </div>

    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4">
      <div class="text-sm text-slate-300">Pre-download (optional)</div>
      <div class="mt-2 text-xs text-slate-500">
        Disabled unless the server explicitly enables model downloads (no internet dependence by default).
      </div>
      <div class="mt-3 flex flex-wrap items-center gap-2">
        <button class="rounded bg-indigo-600 hover:bg-indigo-500 px-3 py-2 text-sm"
                :disabled="!data || !data.downloads?.enabled" @click="prewarm('low')">Prewarm LOW</button>
        <button class="rounded bg-indigo-600 hover:bg-indigo-500 px-3 py-2 text-sm"
                :disabled="!data || !data.downloads?.enabled" @click="prewarm('medium')">Prewarm MED</button>
        <button class="rounded bg-indigo-600 hover:bg-indigo-500 px-3 py-2 text-sm"
                :disabled="!data || !data.downloads?.enabled" @click="prewarm('high')">Prewarm HIGH</button>
      </div>
      <div class="mt-3 text-xs text-slate-500" x-show="data && data.downloads && !data.downloads.enabled" x-cloak
           x-text="data.downloads?.hint || ''"></div>
      <div class="mt-3 text-sm text-slate-200" x-text="status || ''"></div>
    </div>

    <div class="rounded-xl border border-slate-800 bg-slate-900/40 p-4 lg:col-span-2">
      <div class="text-sm text-slate-300">Loaded models (in-process)</div>
      <template x-if="data && Array.isArray(data.loaded) && data.loaded.length">
        <div class="mt-3 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-xs text-slate-500">
              <tr>
                <th class="text-left py-1 pr-3">Kind</th>
                <th class="text-left py-1 pr-3">Model</th>
                <th class="text-left py-1 pr-3">Device</th>
                <th class="text-left py-1 pr-3">Ref</th>
                <th class="text-left py-1 pr-3">Last used</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="m in data.loaded" :key="m.kind + ':' + m.model_name + ':' + m.device">
                <tr class="border-t border-slate-900">
                  <td class="py-1 pr-3 text-slate-200" x-text="m.kind"></td>
                  <td class="py-1 pr-3 text-slate-200 break-all" x-text="m.model_name"></td>
                  <td class="py-1 pr-3 text-slate-200" x-text="m.device"></td>
                  <td class="py-1 pr-3 text-slate-200" x-text="m.refcount"></td>
                  <td class="py-1 pr-3 text-slate-500" x-text="m.last_used_s ? (m.last_used_s.toFixed(1) + 's ago') : ''"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </template>
      <template x-if="data && (!data.loaded || !data.loaded.length)">
        <div class="mt-3 text-sm text-slate-500">No models loaded yet.</div>
      </template>
    </div>
  </div>
</div>

<script>
  function modelsPage() {
    return {
      data: null,
      status: "",
      async init() { await this.load(); },
      async load() {
        this.status = "";
        try {
          const r = await fetch("/api/runtime/models", { credentials: "include" });
          if (!r.ok) {
            this.status = "Unavailable (" + r.status + ")";
            return;
          }
          this.data = await r.json();
        } catch (e) {
          this.status = "Unavailable";
        }
      },
      async prewarm(preset) {
        try {
          this.status = "Starting…";
          const csrf = document.getElementById("csrf")?.value || "";
          const r = await fetch("/api/runtime/models/prewarm?preset=" + encodeURIComponent(preset), {
            method: "POST",
            credentials: "include",
            headers: { "X-CSRF-Token": csrf },
          });
          const d = await r.json().catch(() => ({}));
          if (!r.ok) {
            this.status = (d && d.detail) ? d.detail : ("Failed (" + r.status + ")");
            return;
          }
          this.status = "Started: " + (d.task_id || "ok");
        } catch (e) {
          this.status = "Failed";
        }
      },
    };
  }
</script>
{% endblock %}

